<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="canonical" href="https://queen.raae.codes/2025/05/10/rls-update-select">
        <meta name="description" content="Ahoy, seasoned JavaScript developers and daring dev pirates! Join our swashbuckling crew as we embark on thrilling treasure hunts unraveling the secrets of HTML, CSS, and JavaScript, all while having a blast!">
        <title>UPDATE requires SELECT Row Level Security (RLS) permissions in Postgres/Supabase</title>
                <link rel="stylesheet" href="/assets/build/assets/main-BZO06M8j.css">
        <script defer type="module" src="/assets/build/assets/main-l0sNRNKZ.js"></script>
    </head>
    <body class="text-gray-900 font-sans antialiased">
        <article class="max-w-3xl mx-auto px-4 py-8">
    <header class="mb-8">
        <h1 class="text-4xl font-bold text-brown-900 mb-4">UPDATE requires SELECT Row Level Security (RLS) permissions in Postgres/Supabase</h1>

        
                    <div class="mt-4 flex flex-wrap gap-2">
                                    <span class="px-3 py-1 bg-brown-100 text-brown-800 rounded-full text-sm">
                        PostgreSQL
                    </span>
                                    <span class="px-3 py-1 bg-brown-100 text-brown-800 rounded-full text-sm">
                        RLS
                    </span>
                                    <span class="px-3 py-1 bg-brown-100 text-brown-800 rounded-full text-sm">
                        Auth
                    </span>
                                    <span class="px-3 py-1 bg-brown-100 text-brown-800 rounded-full text-sm">
                        Authorization
                    </span>
                            </div>
            </header>

    <div class="prose prose-lg prose-brown max-w-none">
        <p>When implementing Row Level Security (RLS) in PostgreSQL for <a href="https://outseta-supabase-react-feedback-fort.netlify.app/">Feedback Fort</a> made with React + Supabase + <a href="https://outseta.com/?via=queen">Outseta</a> edition, I spent way way way too long figuring out why soft deleting a vote by updating <code>deleted_at</code> kept stating:</p>

<blockquote>
  <p>new row violates row-level security policy for table "vote"</p>
</blockquote>

<p>ðŸ˜©ðŸ˜©ðŸ˜©</p>

<p>Let's hope this article saves you some time!</p>

<h2>My setup</h2>

<p>I had configured two separate policies:</p>

<pre><code class="language-sql">-- For viewing active votes
CREATE POLICY "Anyone can view active votes"
  ON vote FOR SELECT
  USING (deleted_at IS NULL);

-- For updating votes
CREATE POLICY "Users can update their votes"
  ON vote FOR UPDATE
  USING (auth.jwt() -&gt;&gt; 'sub' = outseta_person_uid)
  WITH CHECK (auth.jwt() -&gt;&gt; 'sub' = outseta_person_uid);
</code></pre>

<p>In my (still beginners) mental model of RLS, the <code>UPDATE</code> policy would only be used when updating the vote, and the <code>SELECT</code> policy would be used when selecting the vote.</p>

<h2>The issue</h2>

<p>So I googled, and found some intersting new knowleged by reading the <a href="https://www.postgresql.org/docs/current/sql-createpolicy.html">PostgreSQL docs</a>.</p>

<blockquote>
  <p>"Typically an <code>UPDATE</code> command also needs to read data from columns in the relation being updated (e.g., in a <code>WHERE</code> clause or a <code>RETURNING</code> clause, or in an expression on the right hand side of the <code>SET</code> clause). In this case, <code>SELECT</code> rights are also required on the relation being updated, and the appropriate <code>SELECT</code> or <code>ALL</code> policies will be applied in addition to the <code>UPDATE</code> policies."</p>
</blockquote>

<p>Or in other words: <strong>UPDATE operations implicitly require SELECT access to the rows being modified</strong></p>

<p>But the user did in fact have <code>SELECT</code> permissions on the vote as when initating the update, <code>deleted_at</code> value was NULL.</p>

<p>So why was the update failing?</p>

<p>ðŸ˜ ðŸ˜ ðŸ˜ </p>

<p>After much googling and head scratching, and testing it seems like <strong>SELECT policies must be valid BOTH before AND after an UPDATE operation</strong>.</p>

<p>I have not succeeded in finding any documentation on this, but numerous posts on Stack Overflow and Github issues seem to suggest this is the case.</p>

<p>But Claude gave me this explanation:</p>

<blockquote>
  <p>PostgreSQL requires SELECT policies to be valid both before and after an UPDATE operation to maintain transactional consistency. This ensures you can always see the results of your own modifications and prevents situations where rows would 'disappear' mid-transaction.</p>
</blockquote>

<p>I would love to get a more authoritative source on this, if you have one, please let me know (queen@raae.codes)!</p>

<h2>The Solution</h2>

<p>The solution in my case was to change the SELECT policy to allow anyone to see active votes and all their votes regardless of status.</p>

<pre><code class="language-sql">-- Modified SELECT policy to see your own votes regardless of deleted status
CREATE POLICY "Users can view their votes"
  ON vote FOR SELECT
  USING (deleted_at IS NULL OR auth.jwt() -&gt;&gt; 'sub' = outseta_person_uid);
</code></pre>

<p>This policy combines two visibility rules:</p>

<ol>
<li>Anyone can see active votes (where <code>deleted_at IS NULL</code>)</li>
<li>Users can always see their votes (where <code>auth.jwt() -&gt;&gt; 'sub' = outseta_person_uid</code>), regardless of deletion status</li>
</ol>

<p>The complete Feedback Fort code is available on <a href="https://github.com/outseta/outseta-supabase-react-feedback-fort">GitHub</a>.</p>

<h2>Key Takeaway</h2>

<ul>
<li>RLS is easy to get started with, but also easy to mess up.</li>
<li>Read the docs ðŸ¤ª</li>
</ul>

<p>But more to the point of this article, remember:</p>

<ol>
<li>UPDATE operations first need to SELECT the rows they'll modify</li>
<li>After an UPDATE, you must still have SELECT access to the modified row</li>
</ol>
    </div>
</article>
    </body>
</html>
