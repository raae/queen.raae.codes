<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="canonical" href="https://queen.raae.codes/2022/05/20/image-modes">
        <meta name="description" content="Ahoy, seasoned JavaScript developers and daring dev pirates! Join our swashbuckling crew as we embark on thrilling treasure hunts unraveling the secrets of HTML, CSS, and JavaScript, all while having a blast!">
        <title>Your plugin should support both Gatsby Image CDN and downloading images as local file nodes</title>
                <link rel="stylesheet" href="/assets/build/assets/main-BZO06M8j.css">
        <script defer type="module" src="/assets/build/assets/main-l0sNRNKZ.js"></script>
    </head>
    <body class="text-gray-900 font-sans antialiased">
        <article class="max-w-3xl mx-auto px-4 py-8">
    <header class="mb-8">
        <h1 class="text-4xl font-bold text-brown-900 mb-4">Your plugin should support both Gatsby Image CDN and downloading images as local file nodes</h1>

        
                    <div class="mt-4 flex flex-wrap gap-2">
                                    <span class="px-3 py-1 bg-brown-100 text-brown-800 rounded-full text-sm">
                        image cdn
                    </span>
                                    <span class="px-3 py-1 bg-brown-100 text-brown-800 rounded-full text-sm">
                        source plugins
                    </span>
                                    <span class="px-3 py-1 bg-brown-100 text-brown-800 rounded-full text-sm">
                        gatsby-node.js
                    </span>
                                    <span class="px-3 py-1 bg-brown-100 text-brown-800 rounded-full text-sm">
                        gatsby-source-youtube-oembed
                    </span>
                                    <span class="px-3 py-1 bg-brown-100 text-brown-800 rounded-full text-sm">
                        images
                    </span>
                                    <span class="px-3 py-1 bg-brown-100 text-brown-800 rounded-full text-sm">
                        createRemoteFileNode
                    </span>
                            </div>
            </header>

    <div class="prose prose-lg prose-brown max-w-none">
        <p>We added back support for downloading the YouTube thumbnails as local file nodes on yesterday's apparently <a href="https://youtu.be/MjcYzjYIFuI">deceiful and spam-packed treasure hunt</a> in the sharky waters around the Gatsby islands</p>

<p><a href="https://twitter.com/raae/status/1527593806513709057?s=20&amp;t=8HbGrJ66ytV2IfM0qvwhDw"><img src="./youtube-spam.png" alt="Hi Queen Raae, Our team has reviewed your content, and we think you may need to make changes to make sure it doesn't violate our spam, deceptive practices and scams policy. In the meantime, we've made the following content private" title="YouTube Email" /></a></p>

<p>We removed it in exchanging for ImageCDN on a <a href="/2022-03-25-image-cdn-plugin/">treasure hunt with Ward of Gatsby</a>, but as we are working on a plugin, I later realized it should support both ü§¶‚Äç‚ôÄÔ∏è</p>

<p><a href="https://youtu.be/IDW2IfaHGIs"><img src="./../../03/25-image-cdn-plugin/youtube-screengrab.jpg" alt="Screengrab of Ward stream" /></a></p>

<h2>The What?</h2>

<p>Let the user of our plugin (gatsby-source-youtube-oembed) decide if they want to utilize Gatsby ImageCDN or download remote images as local file nodes.</p>

<h2>The Why?</h2>

<p>We don't know where our users are deploying their sites as plugin authors. As far as I know, only Netlify and Gatsby Cloud support Gatsby ImageCDN at the moment, and it's pretty clear they'll charge extra for it in the future. Also, some Gatsby users deploy to their own servers or other static hosts.</p>

<h2>The How</h2>

<p>We added a plugin option letting the user configure their choice:</p>

<pre><code class="language-js">// gatsby-node.js
exports.pluginOptionsSchema = ({ Joi }) =&gt; {
  return Joi.object({
    thumbnailMode: Joi.string().valid("none", "cdn", "download").default("cdn"),
  });
};
</code></pre>

<p>Then we made sure to check the plugin option in onCreateNode to decide what type of thumbnail node to make:</p>

<pre><code class="language-js">// gatsby-node.js
const { createRemoteFileNode } = require("gatsby-source-filesystem");

exports.onCreateNode = async (gatsbyUtils, pluginOptions) =&gt; {
  const { node, actions, createNodeId, getCache } = gatsbyUtils;
  const { createNode, createNodeField } = gatsbyUtils.actions;

  if (node.internal.type === YOUTUBE_TYPE) {
    if (pluginOptions.thumbnailMode === "cdn") {
      createNode({
        id: createNodeId(`Thumbnail &gt;&gt;&gt; ${node.youTubeId}`),
        parent: node.id,
        youTubeId: node.youTubeId,
        url: node.oEmbed.thumbnail_url,
        mimeType: "image/jpeg",
        filename: node.youTubeId + ".jpg",
        height: node.oEmbed.thumbnail_height,
        width: node.oEmbed.thumbnail_width,
        internal: {
          type: "YouTubeThumbnail",
          contentDigest: node.internal.contentDigest,
        },
      });
    } else if (pluginOptions.thumbnailMode === "download") {
      const imageFile = await createRemoteFileNode({
        url: node.oEmbed.thumbnail_url,
        parentNodeId: node.id,
        getCache,
        createNode,
        createNodeId,
      });

      createNodeField({
        node: node,
        name: "thumbnailFileId",
        value: imageFile.id,
      });
    }
  }
};
</code></pre>

<p>and we recheck it to customize the schema according to the chosen mode:</p>

<pre><code class="language-js">// gatsby-node.js
const {
  addRemoteFilePolyfillInterface,
} = require("gatsby-plugin-utils/polyfill-remote-file");

exports.createSchemaCustomization = (gatsbyUtils, pluginOptions) =&gt; {
  const { actions, schema } = gatsbyUtils;

  if (pluginOptions.thumbnailMode === "cdn") {
    const YouTubeType = `
      type YouTube implements Node {
        thumbnail: YouTubeThumbnail @link(from: "youTubeId" by: "youTubeId")
      }
    `;

    const YouTubeThumbnailType = addRemoteFilePolyfillInterface(
      schema.buildObjectType({
        name: `YouTubeThumbnail`,
        fields: {
          youTubeId: "String!",
        },
        interfaces: [`Node`, `RemoteFile`],
      }),
      {
        schema,
        actions,
      }
    );

    actions.createTypes([YouTubeType, YouTubeThumbnailType]);
  } else if (pluginOptions.thumbnailMode === "download") {
    const YouTubeType = `
      type YouTube implements Node {
        thumbnail: File @link(from: "fields.thumbnailFileId" by: "id")
      }
    `;
    actions.createTypes(YouTubeType);
  }
};
</code></pre>

<p>We should also update our docs, of course, with examples of how to get hold of the thumbnail image data in both modes, but that is for a later work session.</p>

<p>To see a full diff check out the <a href="https://github.com/queen-raae/gatsby-source-youtube-oembed/pull/11">Pull Request on Github</a>.</p>

<p>&nbsp;<br />
All the best,<br />
Queen Raae</p>
    </div>
</article>
    </body>
</html>
