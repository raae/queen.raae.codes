<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="canonical" href="https://queen.raae.codes/2022/05/27/pagination">
        <meta name="description" content="Ahoy, seasoned JavaScript developers and daring dev pirates! Join our swashbuckling crew as we embark on thrilling treasure hunts unraveling the secrets of HTML, CSS, and JavaScript, all while having a blast!">
        <title>How to paginate through API results when sourcing data</title>
                <link rel="stylesheet" href="/assets/build/assets/main-BZO06M8j.css">
        <script defer type="module" src="/assets/build/assets/main-l0sNRNKZ.js"></script>
    </head>
    <body class="text-gray-900 font-sans antialiased">
        <article class="max-w-3xl mx-auto px-4 py-8">
    <header class="mb-8">
        <h1 class="text-4xl font-bold text-brown-900 mb-4">How to paginate through API results when sourcing data</h1>

        
                    <div class="mt-4 flex flex-wrap gap-2">
                                    <span class="px-3 py-1 bg-brown-100 text-brown-800 rounded-full text-sm">
                        source plugins
                    </span>
                                    <span class="px-3 py-1 bg-brown-100 text-brown-800 rounded-full text-sm">
                        sourceNodes
                    </span>
                                    <span class="px-3 py-1 bg-brown-100 text-brown-800 rounded-full text-sm">
                        onCreateNode
                    </span>
                            </div>
            </header>

    <div class="prose prose-lg prose-brown max-w-none">
        <p>We covered the two ways to paginate through API results when sourcing data on yesterday's <a href="https://youtu.be/y2oIg8xvWC0">unauthorized and rum-fueled treasure hunt</a> in the sharky waters around the Gatsby islands.</p>

<p><a href="https://youtu.be/y2oIg8xvWC0"><img src="./screengrab.jpg" alt="Screengrab of stream" /></a></p>

<h2>The What?</h2>

<p>Get more than the first page of results from an external API.</p>

<p>In our case, that means more than the "max results" returned from each request to the resources endpoint of the Cloudinary API.</p>

<h2>The Why?</h2>

<p>Pagination is needed to solve the bug <a href="https://github.com/cloudinary-devs/gatsby-source-cloudinary/issues/5">Only returns up to 500 results</a> in gatsby-source-cloudinary.</p>

<p>And it's on us to fix it as Cloudinary has hired us to make sure their Gatsby Plugins are up-to-date by summer ðŸŽ‰ðŸŽ‰ðŸŽ‰</p>

<h2>The How</h2>

<p>There are two fundamental ways for solving pagination: recursion and iteration.</p>

<p>Both solve the use case "if there are more results, ask the API for the next page of results".</p>

<p>To not repeatedly ask for the same page, the API needs to know something about the requested page.</p>

<p>It can be the index of the page you are requesting, as seen in the ConvertKit <a href="https://developers.convertkit.com/#list-subscribers">subscribers endpoint</a>.</p>

<p>Or it can be the concept of a cursor as used by Cloudinary. If there are more possible resources than included in the response, Cloudinary adds a next cursor value you then need to provide to the subsequent request for resources.</p>

<h3>Recursion</h3>

<p>Recursion is when a function calls itself within its code. It's a great way to get the same code to execute again and again and again.</p>

<p>But you must also make sure you stop at some point, or you'll continue to infinity and beyond (yes, I did just rewatch Toy Story with the Pirate Princess).</p>

<p><img src="toy-story-buzz-lightyear.gif" alt="Buzz Lightyear spreading his wings and saying &quot;to infinity and beyond&quot;" /></p>

<p>In our case, we only let <code>createCloudinaryNodes</code> call itself if there is a next cursor present in the response coming from Cloudinary.</p>

<pre><code class="language-js">// gatsby-node.js
// ... import and configure cloudinary
const createCloudinaryNodes = async (gatsbyUtils, nextCursor) =&gt; {
  const result = await cloudinary.api.resources({
    resource_type: "image",
    next_cursor: nextCursor,
  });

  gatsbyUtils.reporter.info(
    `Fetched Cloudinary Assets &gt;&gt;&gt; ${result.resources.length} from ${nextCursor}`
  );

  // ... create a node for each resource in result.resource

  if (result.next_cursor) {
    await createCloudinaryNodes(gatsbyUtils, result.next_cursor);
  }
};

exports.sourceNodes = async (gatsbyUtils) =&gt; {
  await createCloudinaryNodes(gatsbyUtils);
};
</code></pre>

<h3>Iteration</h3>

<p>For the iterative solution, we used a do...while loop. The code in the do part of do...while loop will always execute once. And then keep on executing as long as the while condition is true.</p>

<p>In our case, we will keep requesting a new page of resources from Cloudinary until Cloudinary does not respond with the next cursor.</p>

<pre><code class="language-js">// gatsby-node.js
// ... import and configure cloudinary
const createCloudinaryNodes = async (gatsbyUtils) =&gt; {
  let nextCursor = null;

  do {
    const result = await cloudinary.api.resources({
      resource_type: "image",
      next_cursor: nextCursor,
    });

    gatsbyUtils.reporter.info(
      `Fetched Cloudinary Assets &gt;&gt;&gt; ${result.resources.length} from ${nextCursor}`
    );

    // ... create a node for each resource in result.resource

    nextCursor = result.next_cursor;
  } while (nextCursor);
};

exports.sourceNodes = async (gatsbyUtils) =&gt; {
  await createCloudinaryNodes(gatsbyUtils);
};
</code></pre>

<h2>More code!</h2>

<p>To see the "missing" code check out and how to limit the number of resources fetched, check out <a href="https://github.com/queen-raae/gatsby-demo-api-pagination">the demo code on GitHub</a>.</p>

<ul>
<li><a href="https://github.com/queen-raae/gatsby-demo-api-pagination/pull/1">Pagination using recursion</a></li>
<li><a href="https://github.com/queen-raae/gatsby-demo-api-pagination/pull/2">Pagination using iteration</a></li>
</ul>

<p>&nbsp;<br />
All the best,<br />
Queen Raae</p>

<p><strong>PS:</strong> Use the approach you feel most comfortable with. Don't get hung up on tech-bros arguing one over the other!</p>
    </div>
</article>
    </body>
</html>
