<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="canonical" href="https://queen.raae.codes/2022/04/29/tree-problem">
        <meta name="description" content="Ahoy, seasoned JavaScript developers and daring dev pirates! Join our swashbuckling crew as we embark on thrilling treasure hunts unraveling the secrets of HTML, CSS, and JavaScript, all while having a blast!">
        <title>Fixing an abstract syntax tree bug in Gatsby Remark oEmbed</title>
                <link rel="stylesheet" href="/assets/build/assets/main-BZO06M8j.css">
        <script defer type="module" src="/assets/build/assets/main-l0sNRNKZ.js"></script>
    </head>
    <body class="text-gray-900 font-sans antialiased">
        <article class="max-w-3xl mx-auto px-4 py-8">
    <header class="mb-8">
        <h1 class="text-4xl font-bold text-brown-900 mb-4">Fixing an abstract syntax tree bug in Gatsby Remark oEmbed</h1>

        
            </header>

    <div class="prose prose-lg prose-brown max-w-none">
        <p>On yesterday's <a href="https://youtu.be/dRFPUyTEwmo">unauthorized and rum-fueled treasure hunt</a> in the sharky waters around the Gatsby islands, we fixed Issue #102: <a href="https://github.com/queen-raae/gatsby-remark-oembed/issues/102"><code>&lt;div&gt;</code> cannot appear as a descendent of <code>&lt;p&gt;</code></a>.</p>

<p><a href="https://youtu.be/dRFPUyTEwmo"><img src="./youtube-screengrab.png" alt="YouTube Screengrab" /></a></p>

<p>To understand why this was happening, let us take a step back and look at how markdown can be represented as an Abstract Syntax Tree.</p>

<h2>Markdown Abstract Syntax Tree (mdast)</h2>

<p>The following markdown:</p>

<pre><code class="language-md">Intro text, [A link](https://youtu.be/fpFY82efGPI)!

[Another Link](https://youtu.be/fpFY82efGPI)

- [A third link](https://youtu.be/fpFY82efGPI)
- Some text
</code></pre>

<p>as a Markdown Abstract Syntax Tree (mdast):</p>

<p><img src="./mdast-1.png" alt="Markdown Abstract Syntax Tree" /></p>

<p>Each box is called a node, a tree always springs out from a root node, and the nodes without any children are called leaves.</p>

<p>And yes, it is an upside-down tree as Ola pointed out ðŸ¤ª</p>

<h2>Our code</h2>

<p>Gatsby Transformer Remark takes the markdown files, transforms the markdown into mdast, and passes it onto our plugin. We then "walk" the tree looking for standalone links.</p>

<p><img src="./mdast-2.png" alt="Markdown Abstract Syntax Tree" /></p>

<p>Then we swap out the link node for an HTML node if it is indeed an oEmbed link:</p>

<pre><code>const tranformsLinkNodeToOembedNode = ({ node }, oembedResult) =&gt; {
  node.type = "html";
  node.value = oembedResult.html;
  delete node.children;
}
</code></pre>

<p>Giving us a slightly modified tree:</p>

<p><img src="./mdast-3.png" alt="Markdown Abstract Syntax Tree" /></p>

<p>Can you spot the mistake?</p>

<p>.<br />
.<br />
.<br />
.<br />
.<br />
.<br />
.<br />
.</p>

<h2>Our problem</h2>

<p>The HTML node is a child of a paragraph node. Depending on the oEmbed HTML this might result in an invalid HTML structure when the mdast converts into HTML.</p>

<h2>The solution</h2>

<p>Pass along the parent paragraph node as the node to be exchanged for an html node instead!</p>

<p><img src="mdast-4.png" alt="Markdown Abstract Syntax Tree" /></p>

<p>&nbsp;<br />
All the best,<br />
Queen Raae</p>
    </div>
</article>
    </body>
</html>
