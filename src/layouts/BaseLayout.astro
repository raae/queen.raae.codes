---
import siteMetadata from "../data/siteMetadata.js";
import "../global.css";

interface RssFeed {
  title: string;
  href: string;
}

interface Props {
  title?: string;
  description?: string;
  image?: string;
  imageAlt?: string;
  type?: string;
  creator?: string;
  canonical?: string;
  feeds?: RssFeed[];
  children?: any;
}

const { title, description, image, imageAlt, type = "website", creator, canonical: canonicalProp, feeds = [] } = Astro.props;

// Always include the main feed, plus any page-specific feeds
const allFeeds: RssFeed[] = [
  { title: "All Posts â€” Queen Raae & Family", href: "/posts/rss.xml" },
  ...feeds,
];

const { siteName, siteTagline, siteDescription, siteUrl, siteSocialImage, siteSocialImageAlt, siteTwitterCreator } =
  siteMetadata;

const deployUrl =
  import.meta.env.CONTEXT === "production"
    ? (import.meta.env.URL || siteUrl)
    : (import.meta.env.DEPLOY_PRIME_URL || siteUrl);
const siteTitle = `${siteName} â€” ${siteTagline}`;
const pageTitle = title ? `${title}  â€”  ${siteName}` : siteTitle;
const pageImage = image || siteSocialImage;
const pageDescription = description || siteDescription;
const canonical = canonicalProp || `${siteUrl}${Astro.url.pathname}`;
const socialType = type;
const socialTitle = pageTitle;
const socialImage = pageImage && `${deployUrl}${pageImage}`;
const socialImageAlt = image ? imageAlt : siteSocialImageAlt;
const socialDescription = pageDescription;
const twitterSite = siteTwitterCreator;
const twitterCreator = creator || siteTwitterCreator;
const twitterCard = "summary_large_image";
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>{pageTitle}</title>
    <link rel="canonical" href={canonical} />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ‘‘</text></svg>"
    />

    <meta name="description" content={pageDescription} />
    <meta property="og:url" content={canonical} />
    <meta property="og:site_name" content={siteTitle} />
    <meta property="og:type" content={socialType} />
    <meta property="og:title" content={socialTitle} />
    <meta property="og:description" content={socialDescription} />
    {socialImage && <meta property="og:image" content={socialImage} />}

    <meta name="twitter:card" content={twitterCard} />
    <meta name="twitter:site" content={twitterSite} />
    <meta name="twitter:creator" content={twitterCreator} />
    <meta name="twitter:title" content={socialTitle} />
    <meta name="twitter:description" content={socialDescription} />
    {socialImage && <meta name="twitter:image:src" content={socialImage} />}
    {socialImageAlt && <meta name="twitter:image:alt" content={socialImageAlt} />}

    {allFeeds.map(feed => (
      <link rel="alternate" type="application/rss+xml" title={feed.title} href={feed.href} />
    ))}

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,400..900;1,400..900&family=Lora:ital,wght@0,400..700;1,400..700&display=swap"
      rel="stylesheet"
    />

    <style>
      html {
        font-size: clamp(16px, 18px + 0.15vw, 19px);
      }
    </style>

    <!-- Fathom Analytics -->
    <script
      src="https://cdn.usefathom.com/script.js"
      data-site="DIFBAEOT"
      data-included-domains="queen.raae.codes"
      defer></script>

    <slot name="head" />

    <script type="module" is:inline>
      import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs";
      mermaid.initialize({ startOnLoad: false, theme: "default" });

      document.querySelectorAll("pre[data-language='mermaid']").forEach((pre) => {
        const content = pre.querySelector("code").textContent;
        const div = document.createElement("div");
        div.className = "mermaid";
        div.textContent = content;
        pre.replaceWith(div);
      });

      mermaid.run();
    </script>
  </head>
  <body class="bg-plum-800 selection:bg-amber-300 text-plum-900">
    <div class="bg-[#fdf6ec]">
      <slot />
    </div>
  </body>
</html>
