---
interface Props {
  formKey?: string;
  cta?: string;
  tagline?: string;
  message?: string;
  tags?: string[];
  anchor?: string;
  class?: string;
}

const LILLY_LABS_DEFAULTS = {
  formKey: "lillylabs",
  cta: "Yes, please!",
  tagline: "Stay updated!",
  message: "Sign up for the newsletter.",
};

const {
  formKey = LILLY_LABS_DEFAULTS.formKey,
  cta = LILLY_LABS_DEFAULTS.cta,
  tagline = LILLY_LABS_DEFAULTS.tagline,
  message = LILLY_LABS_DEFAULTS.message,
  tags = [],
  anchor = "",
  class: className,
} = Astro.props;

// Form IDs for ConvertKit
const FORM_ID: Record<string, string> = {
  QUEEN: "2454187",
  TIMESHIP: "2604593",
  VERSION4: "2608546",
  REMINDERS: "2816322",
  OLAVEA: "2604593",
  MPYA: "2846086",
  REACTNORWAY: "3380548",
  DEVTASKCHEATSHEET: "3634549",
  JAMSTACK: "3762408",
  LILLYLABS: "1358375",
};

const formId = FORM_ID[formKey.toUpperCase()] || FORM_ID.LILLYLABS;
const emailId = `email-${crypto.randomUUID().slice(0, 8)}`;
---

<form
  id={anchor || undefined}
  class:list={["relative newsletter-form bg-plum-100 p-6 py-5 rounded", className]}
  data-form-id={formId}
  data-tags={JSON.stringify(tags)}
>
  {
    (tagline || message) && (
      <div class="max-w-[48ch] text-pretty">
        {tagline && <strong>{tagline} </strong>}
        <span>{message}</span>
      </div>
    )
  }

  <div class="flex flex-col sm:flex-row mt-5 max-w-[50ch]">
    <div class="relative grow">
    <label for={emailId} class="absolute flex items-center left-3 inset-y-0">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="24px" height="24px" class="w-6 h-6">
        <path fill="#ced8ed" d="M47,11H17C9.268,11,3,17.268,3,25v22h58V25C61,17.268,54.732,11,47,11z"></path>
        <path
          fill="#b5c4e0"
          d="M17.38,11L17.38,11C24.902,11,31,17.098,31,24.62c0,0,0,0,0,0V47l0,0H3l0,0V25.38 C3,17.438,9.438,11,17.38,11z"
        ></path>
        <path fill="#faefde" d="M31,47H11c-1.105,0-2-0.895-2-2V25c0-1.105,0.895-2,2-2h19.65"></path>
        <path fill="#fff7f0" d="M31,32.6l-4.83,3.5c-0.701,0.509-1.649,0.509-2.35,0L9,25.36l1-2.2L31,23V32.6z"></path>
        <path fill="#efd8be" d="M10,47h21v-5H13c-2.209,0-4,1.791-4,4v0.23C9,46.78,9.45,47,10,47z"></path>
        <path fill="#fff" d="M9.83,23.16H31c1.1,0,0,0.9,0,2h1c0,1.1,0.1,2-1,2H9.83C8.73,27.16,8.73,23.16,9.83,23.16z"
        ></path>
        <path fill="#c4939c" d="M29 53H37V64H29z"></path>
        <path fill="#b5c4e0" d="M35,42h22c2.209,0,4,1.791,4,4v1l0,0H31l0,0v-1C31,43.791,32.791,42,35,42z"></path>
        <path
          fill="#f9dd8f"
          d="M61,47H3c-1.105,0-2,0.895-2,2l0,0c0,1.105,0.895,2,2,2h58c1.105,0,2-0.895,2-2l0,0 C63,47.895,62.105,47,61,47z"
        ></path>
        <path
          fill="#ed7899"
          d="M47,2c0-0.552-0.448-1-1-1h-8c-0.552,0-1,0.448-1,1v25c0,1.105,0.895,2,2,2l0,0c1.105,0,2-0.895,2-2 V7c-0.01-0.483,0.327-0.904,0.8-1l4.39-0.88c0.473-0.096,0.81-0.517,0.8-1L47,2z"
        ></path>
        <path
          fill="#f9dd8f"
          d="M38.999 24.005A3 3 0 1 0 38.999 30.005A3 3 0 1 0 38.999 24.005Z"
          transform="rotate(-45.001 38.999 27.005)"></path>
        <path
          fill="#cda1a7"
          d="M39.76,55H26.24c-0.759,0-1.452-0.43-1.79-1.11L23,51h20l-1.45,2.89C41.212,54.57,40.519,55,39.76,55 z"
        ></path>
        <path
          fill="#8d6c9f"
          d="M62,46.18V25c0-8.284-6.716-15-15-15h-5V7l4.39-0.88c0.95-0.189,1.629-1.031,1.61-2V2 c0-1.105-0.895-2-2-2h-8c-1.105,0-2,0.895-2,2v8H17C8.716,10,2,16.716,2,25v21.18c-1.557,0.565-2.362,2.286-1.797,3.843 C0.631,51.202,1.746,51.99,3,52h19.38l1.17,2.34c0.509,1.019,1.551,1.662,2.69,1.66H28v7c0,0.552,0.448,1,1,1s1-0.448,1-1v-7h6v7 c0,0.552,0.448,1,1,1s1-0.448,1-1v-7h1.76c1.135-0.002,2.173-0.644,2.68-1.66L43.62,52H61c1.657-0.013,2.989-1.366,2.977-3.023 C63.967,47.723,63.179,46.608,62,46.18z M38,12V2h8v2.18l-4.39,0.88C40.682,5.244,40.01,6.054,40,7v16.16 c-0.657-0.16-1.343-0.16-2,0V12z M37.59,25.59c0.121-0.123,0.259-0.227,0.41-0.31c0.615-0.372,1.385-0.372,2,0 c0.151,0.083,0.289,0.187,0.41,0.31c0.783,0.779,0.787,2.045,0.008,2.828s-2.045,0.787-2.828,0.008 c-0.783-0.779-0.787-2.045-0.008-2.828C37.584,25.596,37.587,25.593,37.59,25.59z M36,12v12.36c-0.648,0.726-1.004,1.667-1,2.64 c0,2.209,1.791,4,4,4s4-1.791,4-4c0.004-0.973-0.352-1.914-1-2.64V12h5c7.18,0,13,5.82,13,13v1h-6c-0.552,0-1,0.448-1,1s0.448,1,1,1 h6v18H32V25c-0.007-5.373-2.887-10.332-7.55-13H36z M29,46H11c-0.552,0-1-0.448-1-1V27.32l13.24,9.58c1.05,0.761,2.47,0.761,3.52,0 L30,34.56V46H29z M30,25v7.09l-4.41,3.2c-0.349,0.252-0.821,0.252-1.17,0L10,24.87c0.066-0.501,0.495-0.874,1-0.87h18.95 C30,24.33,30,24.66,30,25z M4,25c0.021-7.18,5.858-12.983,13.038-12.962C23.033,12.055,28.239,16.171,29.64,22H11 c-1.657,0-3,1.343-3,3v20c0.003,0.341,0.064,0.679,0.18,1H4V25z M40.66,53.45c-0.169,0.336-0.513,0.549-0.89,0.55H26.24 c-0.377-0.001-0.721-0.214-0.89-0.55L24.62,52h16.76L40.66,53.45z M61,50H3c-0.552,0-1-0.448-1-1s0.448-1,1-1h58 c0.552,0,1,0.448,1,1S61.552,50,61,50z"
        ></path>
        <path
          fill="#8d6c9f"
          d="M46 28h4c.552 0 1-.448 1-1s-.448-1-1-1h-4c-.552 0-1 .448-1 1S45.448 28 46 28zM50 41v2c0 .552.448 1 1 1s1-.448 1-1v-2c0-.552-.448-1-1-1S50 40.448 50 41zM46 44c.552 0 1-.448 1-1v-2c0-.552-.448-1-1-1s-1 .448-1 1v2C45 43.552 45.448 44 46 44zM56 44c.552 0 1-.448 1-1v-2c0-.552-.448-1-1-1s-1 .448-1 1v2C55 43.552 55.448 44 56 44zM41 44c.552 0 1-.448 1-1v-2c0-.552-.448-1-1-1s-1 .448-1 1v2C40 43.552 40.448 44 41 44zM36 44c.552 0 1-.448 1-1v-2c0-.552-.448-1-1-1s-1 .448-1 1v2C35 43.552 35.448 44 36 44z"
        ></path>
      </svg>
      <span class="sr-only">Email:</span>
    </label>

    <input
      id={emailId}
      name="email"
      type="email"
      class="pl-11 font-medium w-full border-solid transition border-2 border-plum-500 focus:border-plum-500 focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-amber-500"
      placeholder="Your best email"
      required
    />
    </div>

    <button
      class="mt-2 sm:mt-0 sm:ml-3 transition shrink-0 text-sm font-semibold px-3 py-2 sm:py-0 justify-center border border-plum-500 bg-plum-500 text-white hover:bg-plum-800 hover:border-plum-800 focus:outline-hidden focus:ring-2 focus:ring-amber-500 focus:ring-offset-2"
      style="font-family: var(--font-label);"
      type="submit"
    >
      {cta}
    </button>
  </div>

  <div
    class="newsletter-alert hidden absolute inset-0 flex flex-col justify-center text-center border-solid border-2 p-4 bg-sky-50 border-sky-800"
    data-alert-type="pending"
  >
    <p class="m-0 text-sm">Hold on...</p>
  </div>

  <div
    class="newsletter-alert hidden absolute inset-0 flex flex-col justify-center text-center border-solid border-2 p-4 bg-emerald-50 border-emerald-800"
    data-alert-type="success"
  >
    <button
      type="button"
      class="newsletter-dismiss h-5 absolute top-2 right-2 transition text-emerald-900 hover:text-emerald-700"
    >
      <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
        <path
          fill-rule="evenodd"
          d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z"
          clip-rule="evenodd"></path>
      </svg>
    </button>
    <h3 class="m-0 mb-0.5 text-sm font-semibold">Almost there!</h3>
    <p class="m-0 text-sm">Check your inbox to confirm...</p>
  </div>

  <div
    class="newsletter-alert hidden absolute inset-0 flex flex-col justify-center text-center border-solid border-2 p-4 bg-red-50 border-red-800"
    data-alert-type="error"
  >
    <button
      type="button"
      class="newsletter-dismiss h-5 absolute top-2 right-2 transition text-red-900 hover:text-red-700"
    >
      <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
        <path
          fill-rule="evenodd"
          d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z"
          clip-rule="evenodd"></path>
      </svg>
    </button>
    <p class="m-0 text-sm">Oh no...something went wrong...</p>
  </div>
</form>

<script>
  document.querySelectorAll(".newsletter-form").forEach((form) => {
    const formEl = form as HTMLFormElement;
    const formId = formEl.dataset.formId;
    const tags = JSON.parse(formEl.dataset.tags || "[]");

    const showAlert = (type: "pending" | "success" | "error") => {
      formEl.querySelectorAll(".newsletter-alert").forEach((alert) => {
        const alertEl = alert as HTMLElement;
        if (alertEl.dataset.alertType === type) {
          alertEl.classList.remove("hidden");
        } else {
          alertEl.classList.add("hidden");
        }
      });
    };

    const setFormDisabled = (disabled: boolean) => {
      const emailInput = formEl.querySelector('input[name="email"]') as HTMLInputElement;
      const submitBtn = formEl.querySelector('button[type="submit"]') as HTMLButtonElement;
      if (emailInput) emailInput.disabled = disabled;
      if (submitBtn) submitBtn.disabled = disabled;
    };

    const hideAlerts = () => {
      formEl.querySelectorAll(".newsletter-alert").forEach((alert) => {
        (alert as HTMLElement).classList.add("hidden");
      });
      setFormDisabled(false);
    };

    formEl.querySelectorAll(".newsletter-dismiss").forEach((btn) => {
      btn.addEventListener("click", hideAlerts);
    });

    formEl.addEventListener("submit", async (e) => {
      e.preventDefault();
      const submitBtn = formEl.querySelector('button[type="submit"]') as HTMLButtonElement;
      if (submitBtn) submitBtn.blur();
      const emailInput = formEl.querySelector('input[name="email"]') as HTMLInputElement;
      const email = emailInput.value;

      setFormDisabled(true);
      showAlert("pending");

      try {
        const endpoint = `https://api.convertkit.com/v3/forms/${formId}/subscribe`;
        const response = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            api_key: import.meta.env.PUBLIC_CK_API_KEY,
            email: email,
            tags: tags,
          }),
        });

        if (response.ok) {
          emailInput.value = "";
          showAlert("success");

          // Track with Fathom if available
          if ((window as any).fathom) {
            (window as any).fathom.trackGoal("LPC2JAXX", 0);
          }
        } else {
          throw new Error("Subscription failed");
        }
      } catch (error) {
        console.warn(error);
        showAlert("error");
      }
    });
  });
</script>
