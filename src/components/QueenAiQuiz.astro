---
import Badge from './Badge.astro';
---

<div class="max-w-4xl mx-auto">
  <!-- Quiz Stats (hidden until first answer) -->
  <div id="quiz-stats" class="hidden text-center mb-6">
    <div class="flex justify-center gap-6 text-sm text-plum-600">
      <span>Score: <span id="current-score" class="font-bold">0</span>/<span id="total-attempts" class="font-bold">0</span></span>
      <span>Accuracy: <span id="accuracy" class="font-bold">0%</span></span>
    </div>
  </div>

  <!-- Quiz Card -->
  <div id="quiz-card" class="bg-white rounded-lg shadow-lg border-2 border-plum-200 p-4 md:p-8 mb-6">
    <!-- Loading State -->
    <div id="loading-state" class="text-center py-12">
      <div class="animate-pulse">
        <div class="h-4 bg-plum-200 rounded w-3/4 mx-auto mb-4"></div>
        <div class="h-4 bg-plum-200 rounded w-1/2 mx-auto mb-4"></div>
        <div class="h-10 bg-plum-200 rounded w-32 mx-auto"></div>
      </div>
    </div>

    <!-- Quiz Content (hidden initially) -->
    <div id="quiz-content" class="hidden">
      <!-- Quote Display -->
      <div class="mb-4 md:mb-8">
        <blockquote class="text-lg md:text-2xl font-body leading-relaxed text-plum-900 italic text-center px-2 md:px-6 mb-4">
          "<span id="quote-text"></span>"
        </blockquote>
        
        <!-- Context (shown after answer) -->
        <div id="quote-context" class="hidden mt-4 p-4 bg-plum-50 rounded-lg">
          <div class="flex flex-wrap gap-2 mb-3">
            <span class="text-sm text-plum-600">Themes:</span>
            <div id="quote-themes" class="flex flex-wrap gap-1"></div>
          </div>
          <p id="context-text" class="text-sm text-plum-700"></p>
          <div id="episode-info" class="text-xs text-plum-500 mt-2"></div>
        </div>
      </div>

      <!-- Answer Buttons -->
      <div id="answer-buttons" class="flex gap-4 justify-center mb-6">
        <button 
          id="btn-queen" 
          class="px-6 py-3 bg-plum-500 text-white font-heading font-bold rounded-lg hover:bg-plum-600 transition-colors border-2 border-plum-500"
          data-answer="real"
        >
          ðŸ‘‘ Real Queen
        </button>
        <button 
          id="btn-ai" 
          class="px-6 py-3 bg-amber-400 text-plum-900 font-heading font-bold rounded-lg hover:bg-amber-500 transition-colors border-2 border-amber-400"
          data-answer="ai"
        >
          ðŸ¤– AI Generated
        </button>
      </div>

      <!-- Result Display (hidden initially) -->
      <div id="result-display" class="hidden text-center">
        <div id="result-icon" class="text-4xl md:text-6xl mb-3"></div>
        <div id="result-text" class="text-lg md:text-xl font-heading font-bold mb-3"></div>
        <button 
          id="next-btn"
          class="px-6 py-3 bg-plum-500 text-white font-heading font-bold rounded-lg hover:bg-plum-600 transition-colors"
        >
          Next Quote â†’
        </button>
      </div>

      <!-- Progress Bar -->
      <div class="mt-6">
        <div class="flex justify-between text-sm text-plum-600 mb-2">
          <span id="progress-text">Quote 1</span>
          <span id="remaining-text"></span>
        </div>
        <div class="w-full bg-plum-200 rounded-full h-2">
          <div id="progress-bar" class="bg-plum-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Instructions & About -->
  <div class="bg-plum-50 rounded-lg p-6">
    <h3 class="text-lg font-heading font-bold text-plum-900 mb-3">How it works:</h3>
    <ul class="text-plum-700 space-y-2">
      <li>â€¢ <strong>Real quotes</strong> are extracted from actual Slow & Steady podcast episodes</li>
      <li>â€¢ <strong>AI quotes</strong> are generated to match Queen Raae's authentic voice and perspective</li>
      <li>â€¢ Each quote includes themes and context after you answer</li>
    </ul>
    <p class="text-sm text-plum-500 mt-4">
      Answers are loaded client-side, so yes â€” you <em>could</em> cheat. 
      A <a href="https://github.com/queen-raae/queen.raae.codes/issues/215" class="underline hover:text-plum-700">cheat-proof version</a> is on the roadmap. 
      For now, we trust you. ðŸ¦€ 
      <a href="https://github.com/queen-raae/queen.raae.codes/pull/213" class="underline hover:text-plum-700">See the PR</a>
    </p>
  </div>
</div>

<script>
  class QueenAiQuiz {
    constructor() {
      this.quotes = [];
      this.currentQuoteIndex = 0;
      this.score = 0;
      this.totalAttempts = 0;
      this.currentQuote = null;
      this.hasAnswered = false;
      
      this.elements = {
        loadingState: document.getElementById('loading-state'),
        quizContent: document.getElementById('quiz-content'),
        quoteText: document.getElementById('quote-text'),
        quoteContext: document.getElementById('quote-context'),
        quoteThemes: document.getElementById('quote-themes'),
        contextText: document.getElementById('context-text'),
        episodeInfo: document.getElementById('episode-info'),
        answerButtons: document.getElementById('answer-buttons'),
        resultDisplay: document.getElementById('result-display'),
        resultIcon: document.getElementById('result-icon'),
        resultText: document.getElementById('result-text'),
        nextBtn: document.getElementById('next-btn'),
        quizStats: document.getElementById('quiz-stats'),
        currentScore: document.getElementById('current-score'),
        totalAttempts: document.getElementById('total-attempts'),
        accuracy: document.getElementById('accuracy'),
        progressText: document.getElementById('progress-text'),
        remainingText: document.getElementById('remaining-text'),
        progressBar: document.getElementById('progress-bar')
      };
      
      this.init();
    }
    
    async init() {
      try {
        // Load quiz data
        const response = await fetch('/queen-ai-quiz.json');
        const data = await response.json();
        // Balanced selection: 10 real + 10 AI for fair 50/50 distribution
        const realQuotes = this.shuffleArray(data.quotes.filter(q => q.isReal)).slice(0, 10);
        const aiQuotes = this.shuffleArray(data.quotes.filter(q => !q.isReal)).slice(0, 10);
        this.quotes = this.shuffleArray([...realQuotes, ...aiQuotes]);
        
        // Hide loading and show quiz
        this.elements.loadingState.classList.add('hidden');
        this.elements.quizContent.classList.remove('hidden');
        
        // Set up event listeners
        this.setupEventListeners();
        
        // Start first question
        this.displayCurrentQuote();
        
      } catch (error) {
        console.error('Failed to load quiz data:', error);
        this.elements.loadingState.innerHTML = `
          <div class="text-center py-12">
            <p class="text-red-600 mb-4">Failed to load quiz data</p>
            <button onclick="location.reload()" class="px-4 py-2 bg-plum-500 text-white rounded hover:bg-plum-600">
              Try Again
            </button>
          </div>
        `;
      }
    }
    
    shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }
    
    setupEventListeners() {
      // Answer buttons
      document.getElementById('btn-queen').addEventListener('click', () => this.handleAnswer(true));
      document.getElementById('btn-ai').addEventListener('click', () => this.handleAnswer(false));
      
      // Next button
      this.elements.nextBtn.addEventListener('click', () => this.nextQuestion());
    }
    
    displayCurrentQuote() {
      if (this.currentQuoteIndex >= this.quotes.length) {
        this.showFinalResults();
        return;
      }
      
      this.currentQuote = this.quotes[this.currentQuoteIndex];
      this.hasAnswered = false;
      
      // Update quote display
      this.elements.quoteText.textContent = this.currentQuote.text;
      
      // Reset UI state
      this.elements.answerButtons.classList.remove('hidden');
      this.elements.resultDisplay.classList.add('hidden');
      this.elements.quoteContext.classList.add('hidden');
      
      // Update progress
      this.updateProgress();
      
      // Reset button states
      document.querySelectorAll('[data-answer]').forEach(btn => {
        btn.classList.remove('opacity-50');
        btn.disabled = false;
      });
    }
    
    handleAnswer(userGuessedReal) {
      if (this.hasAnswered) return;
      
      this.hasAnswered = true;
      this.totalAttempts++;
      
      const isCorrect = userGuessedReal === this.currentQuote.isReal;
      if (isCorrect) {
        this.score++;
      }
      
      // Show result
      this.showResult(isCorrect, this.currentQuote.isReal);
      
      // Disable buttons and show context
      document.querySelectorAll('[data-answer]').forEach(btn => {
        btn.disabled = true;
        if ((btn.dataset.answer === 'real') === this.currentQuote.isReal) {
          btn.classList.add('ring-4', 'ring-green-400');
        }
      });
      
      this.elements.answerButtons.classList.add('hidden');
      this.elements.quoteContext.classList.remove('hidden');
      
      // Update context display
      this.displayContext();
      
      // Update stats
      this.updateStats();
    }
    
    showResult(isCorrect, wasReal) {
      this.elements.resultDisplay.classList.remove('hidden');
      
      if (isCorrect) {
        this.elements.resultIcon.textContent = 'âœ…';
        this.elements.resultText.textContent = `Correct! This was ${wasReal ? 'a real Queen quote' : 'AI generated'}.`;
        this.elements.resultText.className = 'text-xl font-heading font-bold mb-4 text-green-600';
      } else {
        this.elements.resultIcon.textContent = 'âŒ';
        this.elements.resultText.textContent = `Oops! This was ${wasReal ? 'a real Queen quote' : 'AI generated'}.`;
        this.elements.resultText.className = 'text-xl font-heading font-bold mb-4 text-red-600';
      }
    }
    
    displayContext() {
      // Themes
      if (this.currentQuote.themes && this.currentQuote.themes.length > 0) {
        this.elements.quoteThemes.innerHTML = this.currentQuote.themes
          .map(theme => `<span class="px-2 py-1 bg-plum-200 text-plum-800 text-xs rounded">${theme.replace('-', ' ')}</span>`)
          .join(' ');
      }
      
      // Context
      this.elements.contextText.textContent = this.currentQuote.context || 'No additional context available.';
      
      // Episode info (for real quotes)
      if (this.currentQuote.isReal && this.currentQuote.episode) {
        this.elements.episodeInfo.innerHTML = `
          From: Episode ${this.currentQuote.episode} - "${this.currentQuote.title}" 
          ${this.currentQuote.timestamp ? `(${this.currentQuote.timestamp})` : ''}
        `;
        this.elements.episodeInfo.classList.remove('hidden');
      } else {
        this.elements.episodeInfo.classList.add('hidden');
      }
    }
    
    nextQuestion() {
      this.currentQuoteIndex++;
      this.displayCurrentQuote();
    }
    
    updateProgress() {
      const progress = ((this.currentQuoteIndex + 1) / this.quotes.length) * 100;
      const remaining = this.quotes.length - this.currentQuoteIndex - 1;
      
      this.elements.progressText.textContent = `Quote ${this.currentQuoteIndex + 1} of ${this.quotes.length}`;
      this.elements.remainingText.textContent = `${remaining} remaining`;
      this.elements.progressBar.style.width = `${progress}%`;
    }
    
    updateStats() {
      // Show stats after first answer
      this.elements.quizStats.classList.remove('hidden');
      this.elements.currentScore.textContent = this.score;
      this.elements.totalAttempts.textContent = this.totalAttempts;
      
      const accuracy = this.totalAttempts > 0 ? Math.round((this.score / this.totalAttempts) * 100) : 0;
      this.elements.accuracy.textContent = `${accuracy}%`;
    }
    
    showFinalResults() {
      const accuracy = Math.round((this.score / this.totalAttempts) * 100);
      
      this.elements.quizContent.innerHTML = `
        <div class="text-center py-12">
          <h2 class="text-3xl font-heading font-bold text-plum-900 mb-6">Quiz Complete! ðŸŽ‰</h2>
          
          <div class="bg-plum-50 rounded-lg p-8 max-w-md mx-auto mb-8">
            <div class="text-4xl mb-4">${accuracy >= 80 ? 'ðŸ‘‘' : accuracy >= 60 ? 'ðŸ¤–' : 'ðŸ¤”'}</div>
            <div class="text-2xl font-bold text-plum-900 mb-2">
              ${this.score}/${this.totalAttempts} Correct
            </div>
            <div class="text-lg text-plum-700">
              ${accuracy}% Accuracy
            </div>
            <div class="mt-4 text-sm text-plum-600">
              ${accuracy >= 80 ? 'Queen Expert! You know her voice well!' : 
                accuracy >= 60 ? 'Pretty good! You can spot some patterns.' : 
                'Tricky, right? AI is getting quite good at mimicking!'}
            </div>
          </div>
          
          <div class="flex gap-4 justify-center">
            <button 
              onclick="location.reload()" 
              class="px-6 py-3 bg-plum-500 text-white font-heading font-bold rounded-lg hover:bg-plum-600 transition-colors"
            >
              Try Again
            </button>
            <a 
              href="/" 
              class="px-6 py-3 bg-amber-400 text-plum-900 font-heading font-bold rounded-lg hover:bg-amber-500 transition-colors no-underline"
            >
              Back to Home
            </a>
          </div>
        </div>
      `;
    }
  }
  
  // Initialize quiz when page loads
  document.addEventListener('DOMContentLoaded', () => {
    new QueenAiQuiz();
  });
</script>