---
import BaseLayout from '../../layouts/BaseLayout.astro';
import SiteHeader from '../../components/SiteHeader.astro';
import PageSection from '../../components/PageSection.astro';
import PageSectionHeader from '../../components/PageSectionHeader.astro';
import Prose from '../../components/Prose.astro';
import CtaSection from '../../components/CtaSection.astro';
import CtaButton from '../../components/CtaButton.astro';
import Newsletter from '../../components/Newsletter.astro';
import { getCollection, getEntry } from 'astro:content';

// Get the speaker index page content
const speakerIndex = await getEntry('talks', 'index');
const { Content } = await speakerIndex.render();
const page = speakerIndex.data;

// Get all talks (excluding index.md)
const allTalks = await getCollection('talks', (entry) => entry.id !== 'index.md');
const sortedTalks = allTalks.sort((a, b) => b.id.localeCompare(a.id));
---

<BaseLayout
  title={page.title}
  description={page.lead}
>
  <SiteHeader />
  <main>
    <PageSection component="header">
      <PageSectionHeader
        badge={page.badge}
        title={page.title}
        lead={page.lead}
        hLevel={1}
      />

      <Prose>
        <Content />
      </Prose>

      {page.cta && (
        <CtaSection
          class="mt-6"
          href={page.cta.href}
          label={page.cta.label}
          noteTitle={page.cta.noteTitle}
          note={page.cta.note}
        />
      )}
    </PageSection>

    {page.teaser && (
      <PageSection>
        <PageSectionHeader
          badge={page.teaser.badge}
          title={page.teaser.title}
        />

        <Prose>
          <a href={page.teaser.recording}>
            <img
              src="/content/talks/mpya-speaking.jpeg"
              alt={page.imageAlt}
            />
          </a>
        </Prose>

        <a
          class="mt-2 pl-1 block text-xs hover:decoration-amber-600 text-inherit group transition"
          href={page.teaser.recording}
          target="_blank"
          rel="noreferrer"
        >
          {page.teaser.note}
          <svg class="h-4 ml-1.5 fill-amber-600 opacity-30 inline-block translate-y-1 transition-opacity group-hover:opacity-100" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M4.25 5.5a.75.75 0 00-.75.75v8.5c0 .414.336.75.75.75h8.5a.75.75 0 00.75-.75v-4a.75.75 0 011.5 0v4A2.25 2.25 0 0112.75 17h-8.5A2.25 2.25 0 012 14.75v-8.5A2.25 2.25 0 014.25 4h5a.75.75 0 010 1.5h-5z" clip-rule="evenodd" />
            <path fill-rule="evenodd" d="M6.194 12.753a.75.75 0 001.06.053L16.5 4.44v2.81a.75.75 0 001.5 0v-4.5a.75.75 0 00-.75-.75h-4.5a.75.75 0 000 1.5h2.553l-9.056 8.194a.75.75 0 00-.053 1.06z" clip-rule="evenodd" />
          </svg>
        </a>
      </PageSection>
    )}

    <PageSection component="section">
      {page.archive && (
        <PageSectionHeader title={page.archive.title} hLevel={2} />
      )}

      {sortedTalks.map((talk) => {
        const data = talk.data;
        return (
          <article>
            <h3 class="mb-1 mt-9 text-lg font-extrabold">{data.title}</h3>
            <div class="text-sm">
              <p class="my-1">{data.lead}</p>
              {data.event && (
                <p class="my-1 text-xs text-teal-800">
                  {data.eventUrl ? (
                    <a href={data.eventUrl} target="_blank" rel="noreferrer" class="underline hover:decoration-amber-600">
                      {data.event}
                    </a>
                  ) : data.event}
                </p>
              )}
              {data.recording && (
                <a
                  href={data.recording}
                  target="_blank"
                  rel="noreferrer"
                  class="text-xs text-teal-900 underline hover:decoration-amber-600"
                >
                  Watch recording
                </a>
              )}
            </div>
          </article>
        );
      })}

      {page.archive && (
        <CtaButton href={page.archive.moreHref} class="mt-8 w-full">
          {page.archive.more}
        </CtaButton>
      )}
    </PageSection>

    <PageSection component="footer">
      <Newsletter />
    </PageSection>
  </main>
</BaseLayout>
