---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PageSection from '../../components/PageSection.astro';
import PageSectionHeader from '../../components/PageSectionHeader.astro';
import Newsletter from '../../components/Newsletter.astro';
import { getCollection, getEntry } from 'astro:content';

// Get the index content with all the metadata
const indexEntry = await getEntry('talks', 'index');
const { Content } = await indexEntry.render();
const { badge, title, lead, image, imageAlt, archive, teaser, cta } = indexEntry.data as any;

// Get all talks except the index
const allTalks = await getCollection('talks');
const talks = allTalks.filter(talk => talk.id !== 'index.md');

// Helper to extract date from id
function extractDate(id: string): string | null {
  const match = id.match(/(\d{4})-(\d{2})-(\d{2})/);
  return match ? `${match[1]}-${match[2]}-${match[3]}` : null;
}

// Helper to format date
function formatDate(dateStr: string): string {
  const date = new Date(dateStr);
  const options: Intl.DateTimeFormatOptions = { year: 'numeric', month: 'long', day: 'numeric' };
  const formatted = date.toLocaleDateString('en-US', options);
  const day = date.getDate();
  const suffix = day === 1 || day === 21 || day === 31 ? 'st'
               : day === 2 || day === 22 ? 'nd'
               : day === 3 || day === 23 ? 'rd'
               : 'th';
  return formatted.replace(/(\d+),/, `$1${suffix},`);
}

// Sort talks by date (newest first) and add formatted dates
const sortedTalks = talks
  .map(talk => {
    const dateStr = extractDate(talk.id);
    return {
      ...talk,
      dateStr,
      formattedDate: dateStr ? formatDate(dateStr) : '',
    };
  })
  .sort((a, b) => {
    if (a.dateStr && b.dateStr) {
      return new Date(b.dateStr).getTime() - new Date(a.dateStr).getTime();
    }
    return 0;
  });
---

<BaseLayout title={title} description={lead}>
  <main>
    <PageSection component="header">
      <PageSectionHeader
        badge={badge}
        title={title}
        lead={lead}
        hLevel={1}
      />
      <div class="prose prose-brown max-w-none my-4 text-brown-900">
        <Content />
      </div>
    </PageSection>

    {teaser && (
      <PageSection>
        <PageSectionHeader
          badge={teaser.badge}
          title={teaser.title}
          tagline={teaser.note}
        />
        {teaser.recording && (
          <div class="my-6">
            <a
              href={teaser.recording}
              target="_blank"
              rel="noreferrer"
              class="inline-flex items-center text-teal-900 underline underline-offset-2 hover:decoration-amber-600 transition"
            >
              Watch the recording on YouTube
            </a>
          </div>
        )}
      </PageSection>
    )}

    {cta && (
      <PageSection>
        <div class="border-4 border-dashed border-amber-500 p-6">
          <h2 class="text-2xl font-bold mb-4 text-brown-900">{cta.label}</h2>
          <p class="mb-2 text-brown-900">{cta.noteTitle}</p>
          <p class="text-sm text-brown-700 mb-4">{cta.note}</p>
          <a
            href={cta.href}
            class="inline-block bg-amber-500 text-brown-900 px-6 py-3 font-bold hover:bg-amber-600 transition"
          >
            {cta.label}
          </a>
        </div>
      </PageSection>
    )}

    {archive && (
      <PageSection>
        <PageSectionHeader title={archive.title} />
        <ul class="list-none px-0 my-0 -ml-1 space-y-4">
          {sortedTalks.map((talk) => (
            <li class="mx-2 px-5 py-3 pb-4 relative border-0 border-l-4 border-solid border-amber-500 flex flex-col transition hover:bg-amber-400/30 focus-within:border-l-transparent focus-within:ring-4 focus-within:ring-offset-4 focus-within:ring-amber-500">
              <h3 class="text-base my-0 font-bold">
                <a
                  href={`/speaker/${talk.slug}/`}
                  class="text-inherit no-underline focus:outline-none"
                >
                  <span class="absolute inset-0" aria-hidden="true"></span>
                  {talk.data.title}
                </a>
              </h3>
              <p class="text-xs my-0 order-first leading-8 font-medium text-teal-800 uppercase tracking-tight">
                {talk.formattedDate}
                {talk.data.event && (
                  <>
                    <span class="px-1">Â·</span>
                    {talk.data.event}
                  </>
                )}
              </p>
              {talk.data.recording && (
                <a
                  href={talk.data.recording}
                  target="_blank"
                  rel="noreferrer"
                  class="relative z-10 mt-2 text-sm text-teal-900 underline underline-offset-2 hover:decoration-amber-600 transition"
                >
                  Watch the recording on YouTube
                </a>
              )}
            </li>
          ))}
        </ul>
        {archive.moreHref && (
          <div class="mt-8">
            <a
              href={archive.moreHref}
              target="_blank"
              rel="noreferrer"
              class="inline-block bg-brown-700 text-brown-50 px-6 py-3 hover:bg-brown-800 transition"
            >
              {archive.more}
            </a>
          </div>
        )}
      </PageSection>
    )}

    <PageSection component="footer">
      <Newsletter />
    </PageSection>
  </main>
</BaseLayout>
