---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  const talks = await getCollection('talks');
  const filteredTalks = talks.filter(talk => talk.id !== 'index.md');

  return filteredTalks.map((talk) => ({
    params: { slug: talk.slug },
    props: { talk },
  }));
}

const { talk } = Astro.props;
const { Content } = await talk.render();

// Extract date from slug (format: YYYY-MM-DD-name)
const dateMatch = talk.id.match(/(\d{4})-(\d{2})-(\d{2})/);
const dateStr = dateMatch ? `${dateMatch[1]}-${dateMatch[2]}-${dateMatch[3]}` : '';
const formattedDate = dateMatch ? new Date(`${dateMatch[1]}-${dateMatch[2]}-${dateMatch[3]}`).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
}) : '';
---

<BaseLayout title={talk.data.title}>
  <div class="min-h-screen px-4 py-8 max-w-4xl mx-auto">
    <nav class="mb-6 text-sm">
      <a href="/speaker/" class="text-brown-700 hover:text-teal-900">← Speaker</a>
      {formattedDate && <span class="mx-2 text-brown-700">•</span>}
      {formattedDate && <time datetime={dateStr} class="text-brown-700">{formattedDate}</time>}
    </nav>

    <article>
      <header class="mb-8">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">{talk.data.title}</h1>

        {talk.data.event && (
          <div class="text-lg text-brown-700 mb-4">
            {talk.data.eventUrl ? (
              <a href={talk.data.eventUrl} target="_blank" rel="noreferrer" class="hover:text-teal-900 hover:underline">
                {talk.data.event} ↗
              </a>
            ) : (
              talk.data.event
            )}
          </div>
        )}

        {talk.data.recording && (
          <a
            href={talk.data.recording}
            target="_blank"
            rel="noreferrer"
            class="inline-block bg-amber-500 text-brown-900 px-6 py-3 rounded font-bold hover:bg-amber-600 transition"
          >
            Watch recording ↗
          </a>
        )}
      </header>

      <div class="prose prose-brown prose-lg max-w-none">
        <Content />
      </div>

      {talk.data.form && (
        <div class="mt-12 p-6 border-4 border-dashed border-amber-500">
          <h2 class="text-2xl font-bold mb-4">{talk.data.form.title}</h2>
          {talk.data.form.message && <p class="mb-4">{talk.data.form.message}</p>}
          <div class="text-center">
            <a href={`/subs/?key=${talk.data.form.key}`} class="inline-block bg-amber-500 text-brown-900 px-6 py-3 rounded font-bold hover:bg-amber-600 transition">
              {talk.data.form.cta || 'Sign up'}
            </a>
          </div>
        </div>
      )}
    </article>

    <footer class="mt-12 p-6 border-4 border-dashed border-amber-500">
      <h2 class="text-2xl font-bold mb-4">Interested in more?</h2>
      <p class="mb-4">Subscribe to get emails about web development and pirate adventures!</p>
      <div class="text-center">
        <a href="/subs/" class="inline-block bg-amber-500 text-brown-900 px-6 py-3 rounded font-bold hover:bg-amber-600 transition">
          Sign up for the newsletter
        </a>
      </div>
    </footer>
  </div>
</BaseLayout>
