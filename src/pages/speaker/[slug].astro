---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PageSection from '../../components/PageSection.astro';
import PageSectionHeader from '../../components/PageSectionHeader.astro';
import PageSectionBreadcrumbs from '../../components/PageSectionBreadcrumbs.astro';
import Newsletter from '../../components/Newsletter.astro';

export async function getStaticPaths() {
  const talks = await getCollection('talks');
  const filteredTalks = talks.filter(talk => talk.id !== 'index.md');

  return filteredTalks.map((talk) => ({
    params: { slug: talk.slug },
    props: { talk },
  }));
}

const { talk } = Astro.props;
const { Content } = await talk.render();

// Extract date from slug (format: YYYY-MM-DD-name)
const dateMatch = talk.id.match(/(\d{4})-(\d{2})-(\d{2})/);
const dateStr = dateMatch ? `${dateMatch[1]}-${dateMatch[2]}-${dateMatch[3]}` : '';

function formatDate(dateStr: string): string {
  const date = new Date(dateStr);
  const options: Intl.DateTimeFormatOptions = { year: 'numeric', month: 'long', day: 'numeric' };
  const formatted = date.toLocaleDateString('en-US', options);
  const day = date.getDate();
  const suffix = day === 1 || day === 21 || day === 31 ? 'st'
               : day === 2 || day === 22 ? 'nd'
               : day === 3 || day === 23 ? 'rd'
               : 'th';
  return formatted.replace(/(\d+),/, `$1${suffix},`);
}

const formattedDate = dateStr ? formatDate(dateStr) : '';
---

<BaseLayout title={talk.data.title}>
  <main>
    <PageSection component="article">
      <PageSectionBreadcrumbs
        class="mt-4"
        items={[
          { label: 'Speaker', to: '/speaker/' },
          { label: talk.data.title }
        ]}
      />

      <PageSectionHeader hLevel={1} title={talk.data.title} />

      {formattedDate && (
        <p class="text-xs my-0 order-first leading-8 font-medium text-teal-800 uppercase tracking-tight">
          {formattedDate}
          {talk.data.event && (
            <>
              <span class="px-1">Â·</span>
              {talk.data.eventUrl ? (
                <a href={talk.data.eventUrl} target="_blank" rel="noreferrer" class="hover:text-teal-700 hover:underline">
                  {talk.data.event}
                </a>
              ) : talk.data.event}
            </>
          )}
        </p>
      )}

      {talk.data.recording && (
        <div class="my-6">
          <a
            href={talk.data.recording}
            target="_blank"
            rel="noreferrer"
            class="inline-flex items-center text-teal-900 underline underline-offset-2 hover:decoration-amber-600 transition"
          >
            Watch the recording on YouTube
          </a>
        </div>
      )}

      <div class="prose prose-brown prose-lg max-w-none my-6 text-brown-900">
        <Content />
      </div>
    </PageSection>

    {talk.data.form && (
      <PageSection>
        <Newsletter
          formKey={talk.data.form.key}
          cta={talk.data.form.cta || 'Sign up'}
          tagline={talk.data.form.title}
          message={talk.data.form.message}
        />
      </PageSection>
    )}

    <PageSection component="footer">
      <Newsletter />
    </PageSection>
  </main>
</BaseLayout>
