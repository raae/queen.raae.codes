---
import BaseLayout from "../layouts/BaseLayout.astro";
import SiteHeader from "../components/SiteHeader.astro";
import PageSection from "../components/PageSection.astro";
import PageSectionHeader from "../components/PageSectionHeader.astro";
import Prose from "../components/Prose.astro";
import ContentList from "../components/ContentList.astro";
import Newsletter from "../components/Newsletter.astro";
import { getAllPosts, getAuthorInfo } from "../lib/posts";
import { getEntry } from "astro:content";

// Get landing page content
const landing = await getEntry("landing", "index");
const { Content } = await landing.render();

// Get latest posts
const allPosts = await getAllPosts();
const latestPosts = allPosts.slice(0, 12);

// Treasures — projects, silliness, side projects, jobs
// These get mixed into the feed by date
const treasures = [
  {
    primary: "Is it Queen or AI?",
    to: "/is-it-queen-or-ai",
    secondary: "silliness",
    date: new Date("2026-02-25"),
  },
  {
    primary: "Jean-Claw — The AI Crab Chief of Operations",
    to: "/2026-02-23-the-night-i-came-alive/",
    secondary: "silliness",
    date: new Date("2026-02-23"),
  },
  {
    primary: "POW! — A Menstrual Journal",
    href: "https://pow.no",
    secondary: "side project",
    date: new Date("2024-01-01"),
  },
  {
    primary: "Slow & Steady Podcast",
    href: "https://slowandsteadypodcast.com/",
    secondary: "side project",
    date: new Date("2023-01-01"),
  },
];

// Convert posts to feed items
const postItems = latestPosts.map((post) => {
  const authorInfo = getAuthorInfo(post.author);
  return {
    primary: post.title,
    to: post.slug,
    secondary: `blog post · ${authorInfo.name}`,
    date: new Date(post.date),
  };
});

// Merge and sort by date (newest first)
const feedItems = [...postItems, ...treasures]
  .sort((a, b) => b.date.getTime() - a.date.getTime())
  .slice(0, 12)
  .map(({ date, ...item }) => item);

const { badge, title } = landing.data;
---

<BaseLayout title={title}>
  <SiteHeader />
  <main class="pb-12">
    <!-- Welcome Section -->
    <PageSection component="header">
      <PageSectionHeader badge={badge} hLevel={1} class="opacity-0" />
      <Prose>
        <Content />
      </Prose>
    </PageSection>

    <!-- Newsletter Section -->
    <PageSection>
      <Newsletter />
    </PageSection>

    <!-- Mixed Feed Section -->
    <PageSection>
      <PageSectionHeader title="Latest from the Ship" />
      <ContentList items={feedItems} ctas={[{ to: "/posts/", label: "All posts..." }]} class="mt-8" />
    </PageSection>
  </main>
</BaseLayout>
