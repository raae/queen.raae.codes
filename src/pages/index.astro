---
import BaseLayout from '../layouts/BaseLayout.astro';
import PageSection from '../components/PageSection.astro';
import PageSectionHeader from '../components/PageSectionHeader.astro';
import ContentList from '../components/ContentList.astro';
import Newsletter from '../components/Newsletter.astro';
import { getCollection } from 'astro:content';

// Helper to format date
function formatDate(dateStr: string): string {
  const date = new Date(dateStr);
  const options: Intl.DateTimeFormatOptions = { year: 'numeric', month: 'long', day: 'numeric' };
  const formatted = date.toLocaleDateString('en-US', options);
  const day = date.getDate();
  const suffix = day === 1 || day === 21 || day === 31 ? 'st'
               : day === 2 || day === 22 ? 'nd'
               : day === 3 || day === 23 ? 'rd'
               : 'th';
  return formatted.replace(/(\d+),/, `$1${suffix},`);
}

// Helper to extract date from post id
function extractPostDate(id: string): string | null {
  const match = id.match(/(\d{4})\/(\d{2})\/(\d{2})/);
  return match ? `${match[1]}-${match[2]}-${match[3]}` : null;
}

// Helper to extract date from talk id
function extractTalkDate(id: string): string | null {
  const match = id.match(/(\d{4})-(\d{2})-(\d{2})/);
  return match ? `${match[1]}-${match[2]}-${match[3]}` : null;
}

const queenPosts = await getCollection('posts-queen');
const sortedPosts = queenPosts
  .map(post => {
    const dateStr = extractPostDate(post.id);
    return {
      ...post,
      dateStr,
      formattedDate: dateStr ? formatDate(dateStr) : '',
    };
  })
  .sort((a, b) => {
    if (a.dateStr && b.dateStr) {
      return new Date(b.dateStr).getTime() - new Date(a.dateStr).getTime();
    }
    return 0;
  })
  .slice(0, 5);

const allTalks = await getCollection('talks');
const talks = allTalks.filter(talk => talk.id !== 'index.md');
const sortedTalks = talks
  .map(talk => {
    const dateStr = extractTalkDate(talk.id);
    return {
      ...talk,
      dateStr,
      formattedDate: dateStr ? formatDate(dateStr) : '',
    };
  })
  .sort((a, b) => {
    if (a.dateStr && b.dateStr) {
      return new Date(b.dateStr).getTime() - new Date(a.dateStr).getTime();
    }
    return 0;
  })
  .slice(0, 3);
---

<BaseLayout title="Sailing the high seas of the World Wide Web">
  <main>
    <PageSection component="header">
      <PageSectionHeader
        badge="Queen Raae"
        title="Sailing the high seas of the World Wide Web"
        hLevel={1}
      />
      <div class="prose prose-brown max-w-none my-4 text-brown-900">
        <p class="text-lg font-medium leading-snug">
          Ahoy, seasoned JavaScript developers and daring dev pirates! Join our swashbuckling crew as we embark on thrilling treasure hunts unraveling the secrets of HTML, CSS, and JavaScript, all while having a blast!
        </p>
      </div>
    </PageSection>

    <PageSection>
      <PageSectionHeader
        badge="YouTube Live"
        title="Set sail with us every other Saturday"
        tagline="Join us at 11:00 CET on YouTube for web development treasure hunts!"
      />
      <div class="my-6">
        <a
          href="https://www.youtube.com/QueenRaae/live"
          target="_blank"
          rel="noreferrer"
          class="inline-flex items-center text-teal-900 underline underline-offset-2 hover:decoration-amber-600 transition"
        >
          Watch live on YouTube
        </a>
      </div>
    </PageSection>

    <PageSection>
      <Newsletter />
    </PageSection>

    <PageSection>
      <PageSectionHeader
        badge="Products & Services"
        title="Are you stuck on a reef?"
        tagline="Get Unstuck. Gain confidence. Take Action."
      />
      <div class="my-4">
        <a
          href="/emergency/"
          class="inline-flex items-center text-teal-900 underline underline-offset-2 hover:decoration-amber-600 transition"
        >
          Book an Emergency Call
        </a>
      </div>
    </PageSection>

    <PageSection>
      <PageSectionHeader
        title="Latest Posts"
        titlePath="/posts/"
      />
      <ContentList items={sortedPosts.map(post => ({
        to: `/${post.slug}/`,
        primary: post.data.title,
        secondary: post.formattedDate
      }))} />
    </PageSection>

    <PageSection>
      <PageSectionHeader
        badge="Noteworthy"
        title="Talks, Webinars and Streams"
        titlePath="/speaker/"
      />
      <ContentList items={sortedTalks.map(talk => ({
        to: `/speaker/${talk.slug}/`,
        primary: talk.data.title,
        secondary: talk.data.event || talk.formattedDate
      }))} />
    </PageSection>

    <PageSection>
      <PageSectionHeader
        badge="About"
        title="Who are we?"
      />
      <div class="prose prose-brown max-w-none my-4 text-brown-900">
        <p>
          Queen Raae is a seasoned web developer who loves duct-taping together side projects in addition to making apps trusted by the Swedish Armed Forces, The Norwegian Water Resources and Energy Directorate, and others.
        </p>
        <p>
          Cap'n Ola is the junior developer with a business background who asks all the right questions!
        </p>
        <p>
          Together with Pirate Princess Lillian, we spend our days sailing the sharky waters around the web.
        </p>
        <p>
          Join us for our{" "}
          <a href="https://www.youtube.com/QueenRaae" target="_blank" rel="noopener" class="text-teal-900 underline underline-offset-2 hover:decoration-amber-600 transition">
            weekly treasure hunts
          </a>{" "}
          over on YouTube to get to know us better!
        </p>
      </div>
    </PageSection>

    <PageSection component="footer">
      <Newsletter />
    </PageSection>
  </main>
</BaseLayout>
