---
import BaseLayout from "../layouts/BaseLayout.astro";
import SiteHeader from "../components/SiteHeader.astro";
import PageSection from "../components/PageSection.astro";
import PageSectionHeader from "../components/PageSectionHeader.astro";
import Prose from "../components/Prose.astro";
import ContentList from "../components/ContentList.astro";
import Newsletter from "../components/Newsletter.astro";
import { getAllPosts, getAuthorInfo } from "../lib/posts";
import { getEntry } from "astro:content";

// Get landing page content
const landing = await getEntry("landing", "index");
const { Content } = await landing.render();

// Get latest posts
const allPosts = await getAllPosts();
const latestPosts = allPosts.slice(0, 10);

// Treasures â€” interleaved every other with posts after first 3
const treasures = [
  {
    primary: "Book Queen Raae as a Speaker",
    to: "/speaker/",
    secondary: 'Speaking <em class="font-body">by</em> Queen Raae ðŸ‘‘',
  },
  {
    primary: "Is it Queen or AI?",
    to: "/is-it-queen-or-ai",
    secondary: 'Quiz Game <em class="font-body">by</em> Jean-Claw ðŸ¦€',
  },
  {
    primary: "POW! â€” A Menstrual Journal",
    href: "https://pow.no",
    secondary: 'Side Project <em class="font-body">by</em> Queen Raae ðŸ‘‘',
  },
  {
    primary: "Slow & Steady Podcast",
    href: "https://slowandsteadypodcast.com/",
    secondary: 'Podcast <em class="font-body">by</em> Benedikt Deicke ðŸŽ™ï¸',
  },
];

// Convert posts to feed items with uniform format
const postItems = latestPosts.map((post) => {
  const authorInfo = getAuthorInfo(post.author);
  return {
    primary: post.title,
    to: post.slug,
    secondary: `Blog Post Â· ${post.dateFormatted} <em class="font-body">by</em> ${authorInfo.name} ${authorInfo.emoji}`,
  };
});

// 3 latest posts, then alternate: treasure, post, treasure, post...
const feedItems = [...postItems.slice(0, 3)];
const remainingPosts = postItems.slice(3);
let tIdx = 0;
let pIdx = 0;
while (tIdx < treasures.length || pIdx < remainingPosts.length) {
  if (tIdx < treasures.length) feedItems.push(treasures[tIdx++]);
  if (pIdx < remainingPosts.length) feedItems.push(remainingPosts[pIdx++]);
}

const { badge, title } = landing.data;
---

<BaseLayout title={title}>
  <SiteHeader />
  <main class="pb-12">
    <!-- Welcome Section -->
    <PageSection component="header">
      <PageSectionHeader badge={badge} title={title} hLevel={1} />
      <Prose>
        <Content />
      </Prose>
    </PageSection>

    <!-- Newsletter Section -->
    <PageSection>
      <Newsletter />
    </PageSection>

    <!-- Mixed Feed Section -->
    <PageSection>
      <ContentList items={feedItems} ctas={[{ to: "/posts/", label: "All posts..." }]} />
    </PageSection>
  </main>
</BaseLayout>
