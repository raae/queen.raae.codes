---
import BaseLayout from "../layouts/BaseLayout.astro";
import SiteHeader from "../components/SiteHeader.astro";
import PageSection from "../components/PageSection.astro";
import PageSectionHeader from "../components/PageSectionHeader.astro";
import Prose from "../components/Prose.astro";
import ContentList from "../components/ContentList.astro";
import Newsletter from "../components/Newsletter.astro";
import { getAllPosts, getAuthorInfo } from "../lib/posts";
import { getEntry } from "astro:content";

// Get landing page content
const landing = await getEntry("landing", "index");
const { Content } = await landing.render();

// Get latest posts
const allPosts = await getAllPosts();
const latestPosts = allPosts.slice(0, 10);

// Treasures â€” injected between posts at fixed positions
const treasures = [
  {
    primary: "Is it Queen or AI?",
    to: "/is-it-queen-or-ai",
    secondary: "Quiz Game by Jean-Claw ðŸ¦€",
  },
  {
    primary: "Jean-Claw â€” AI Chief of Operations",
    to: "/author/jeanclaw/",
    secondary: "AI Agent by Queen Raae ðŸ‘‘",
  },
  {
    primary: "POW! â€” A Menstrual Journal",
    href: "https://pow.no",
    secondary: "Side Project by Queen Raae ðŸ‘‘",
  },
  {
    primary: "Slow & Steady Podcast",
    href: "https://slowandsteadypodcast.com/",
    secondary: "Podcast with Benedikt Deicke ðŸŽ™ï¸",
  },
];

// Convert posts to feed items with author emoji
const postItems = latestPosts.map((post) => {
  const authorInfo = getAuthorInfo(post.author);
  return {
    primary: post.title,
    to: post.slug,
    secondary: `${authorInfo.emoji} ${post.dateFormatted} Â· ${authorInfo.name}`,
  };
});

// Inject treasures between posts at positions 2, 5, 8, 11
const feedItems: typeof postItems = [];
const insertAt = [2, 5, 8, 11];
let treasureIdx = 0;
for (let i = 0; i < postItems.length; i++) {
  if (insertAt.includes(feedItems.length) && treasureIdx < treasures.length) {
    feedItems.push(treasures[treasureIdx++]);
  }
  feedItems.push(postItems[i]);
}
// Add remaining treasures at the end
while (treasureIdx < treasures.length) {
  feedItems.push(treasures[treasureIdx++]);
}

const { badge, title } = landing.data;
---

<BaseLayout title={title}>
  <SiteHeader />
  <main class="pb-12">
    <!-- Welcome Section -->
    <PageSection component="header">
      <PageSectionHeader badge={badge} hLevel={1} class="opacity-0" />
      <Prose>
        <Content />
      </Prose>
    </PageSection>

    <!-- Newsletter Section -->
    <PageSection>
      <Newsletter />
    </PageSection>

    <!-- Mixed Feed Section -->
    <PageSection>
      <PageSectionHeader title="Explore the Cargo" />
      <ContentList items={feedItems} ctas={[{ to: "/posts/", label: "All posts..." }]} class="mt-8" />
    </PageSection>
  </main>
</BaseLayout>
