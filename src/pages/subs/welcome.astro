---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PageSection from '../../components/PageSection.astro';
import PageSectionHeader from '../../components/PageSectionHeader.astro';
import PageSectionBreadcrumbs from '../../components/PageSectionBreadcrumbs.astro';
import ContentList from '../../components/ContentList.astro';
import { getCollection } from 'astro:content';

const BADGE = "Emails";
const TITLE = "Welcome";
const LEAD = "You'll hear from us shortly";

// Helper to format date
function formatDate(dateStr: string): string {
  const date = new Date(dateStr);
  const options: Intl.DateTimeFormatOptions = { year: 'numeric', month: 'long', day: 'numeric' };
  const formatted = date.toLocaleDateString('en-US', options);
  const day = date.getDate();
  const suffix = day === 1 || day === 21 || day === 31 ? 'st'
               : day === 2 || day === 22 ? 'nd'
               : day === 3 || day === 23 ? 'rd'
               : 'th';
  return formatted.replace(/(\d+),/, `$1${suffix},`);
}

// Helper to extract date from id
function extractDate(id: string): string | null {
  const match = id.match(/(\d{4})\/(\d{2})\/(\d{2})/);
  return match ? `${match[1]}-${match[2]}-${match[3]}` : null;
}

const queenPosts = await getCollection('posts-queen');
const sortedPosts = queenPosts
  .map(post => {
    const dateStr = extractDate(post.id);
    return {
      ...post,
      dateStr,
      formattedDate: dateStr ? formatDate(dateStr) : '',
    };
  })
  .sort((a, b) => {
    if (a.dateStr && b.dateStr) {
      return new Date(b.dateStr).getTime() - new Date(a.dateStr).getTime();
    }
    return 0;
  })
  .slice(0, 10);
---

<BaseLayout title={`${BADGE} - ${TITLE}`} description={LEAD}>
  <main>
    <PageSection component="header">
      <PageSectionBreadcrumbs
        class="mt-4"
        items={[
          { label: BADGE, to: '/subs/' },
          { label: TITLE }
        ]}
      />
      <PageSectionHeader
        title={LEAD}
        hLevel={1}
      />
    </PageSection>

    <PageSection>
      <PageSectionHeader
        title="Latest Posts"
        titlePath="/posts/"
      />
      <ContentList items={sortedPosts.map(post => ({
        to: `/${post.slug}/`,
        primary: post.data.title,
        secondary: post.formattedDate
      }))} />
    </PageSection>
  </main>
</BaseLayout>
