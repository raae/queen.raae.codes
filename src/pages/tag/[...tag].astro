---
import BaseLayout from "../../layouts/BaseLayout.astro";
import SiteHeader from "../../components/SiteHeader.astro";
import PageSection from "../../components/PageSection.astro";
import PageSectionHeader from "../../components/PageSectionHeader.astro";
import PageSectionBreadcrumbs from "../../components/PageSectionBreadcrumbs.astro";
import Posts from "../../components/Posts.astro";
import Newsletter from "../../components/Newsletter.astro";
import { getAllTags } from "../../lib/posts";
import { getTagBlurbs } from "../../lib/tag-blurbs";

export async function getStaticPaths() {
  const tagsMap = await getAllTags();

  return Array.from(tagsMap.entries()).map(([slug, { label, posts }]) => {
    // Remove /tag/ prefix and trailing slash
    const tagParam = slug.replace(/^\/tag\//, "").replace(/\/$/, "");
    return {
      params: { tag: tagParam },
      props: { label, posts },
    };
  });
}

const { label, posts } = Astro.props;

const blurbMap = await getTagBlurbs();
const blurb = blurbMap.get(label);

const title = `Posts tagged: "${label}"`;
const description = blurb?.description || `Learn more about "${label}" by browsing the posts for the tag.`;
---

<BaseLayout title={title} description={description}>
  <SiteHeader />

  <main>
    <PageSection component="article">
      <PageSectionBreadcrumbs class="mt-4" items={[{ label: "Posts", to: "/posts/" }, { label: label }]} />
      <PageSectionHeader title={title} hLevel={1} />

      {blurb && (blurb.description || blurb.disclaimer || blurb.url) && (
        <aside class="my-6 text-sm italic text-plum-400" style="font-family: var(--font-body); text-wrap: balance;">
          <p>
            <span class="not-italic text-amber-500">✦</span>{" "}
            <strong class="not-italic text-plum-600">{blurb.displayName || label}</strong>
            {blurb.description && <span> — {blurb.description}</span>}
            {blurb.disclaimer && <span> {blurb.disclaimer}</span>}
            {blurb.url && (
              <Fragment>
                {" "}<span class="not-italic text-amber-500">✦</span>{" "}
                <a href={blurb.url} class="underline decoration-plum-300 underline-offset-3 hover:text-[#f4511e] hover:decoration-[#f4511e] transition" target="_blank" rel="noopener noreferrer">{blurb.url.replace(/^https?:\/\//, "")}</a>
              </Fragment>
            )}
            {" "}<span class="not-italic text-amber-500">✦</span>
          </p>
        </aside>
      )}

      <Posts posts={posts} />
    </PageSection>

    <PageSection component="footer">
      <Newsletter />
    </PageSection>
  </main>
</BaseLayout>
