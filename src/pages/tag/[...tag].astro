---
import BaseLayout from "../../layouts/BaseLayout.astro";
import SiteHeader from "../../components/SiteHeader.astro";
import PageSection from "../../components/PageSection.astro";
import PageSectionHeader from "../../components/PageSectionHeader.astro";
import PageSectionBreadcrumbs from "../../components/PageSectionBreadcrumbs.astro";
import Posts from "../../components/Posts.astro";
import Newsletter from "../../components/Newsletter.astro";
import { getAllTags } from "../../lib/posts";

export async function getStaticPaths() {
  const tagsMap = await getAllTags();

  return Array.from(tagsMap.entries()).map(([slug, { label, posts }]) => {
    // Remove /tag/ prefix and trailing slash
    const tagParam = slug.replace(/^\/tag\//, "").replace(/\/$/, "");
    return {
      params: { tag: tagParam },
      props: { label, posts },
    };
  });
}

const { label, posts } = Astro.props;

const title = `Posts tagged: "${label}"`;
const description = `Learn more about "${label}" by browsing the posts for the tag.`;
---

<BaseLayout title={title} description={description}>
  <SiteHeader />

  <main>
    <PageSection component="article">
      <PageSectionBreadcrumbs class="mt-4" items={[{ label: "Posts", to: "/posts/" }, { label: label }]} />
      <PageSectionHeader title={title} hLevel={1} />

      <Posts posts={posts} />
    </PageSection>

    <PageSection component="footer">
      <Newsletter />
    </PageSection>
  </main>
</BaseLayout>
