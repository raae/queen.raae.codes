---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import PageSection from '../../components/PageSection.astro';
import PageSectionHeader from '../../components/PageSectionHeader.astro';
import PageSectionBreadcrumbs from '../../components/PageSectionBreadcrumbs.astro';
import Newsletter from '../../components/Newsletter.astro';
import ContentList from '../../components/ContentList.astro';

// Helper to format date like "January 25th, 2025"
function formatDate(dateStr: string): string {
  const date = new Date(dateStr);
  const options: Intl.DateTimeFormatOptions = { year: 'numeric', month: 'long', day: 'numeric' };
  const formatted = date.toLocaleDateString('en-US', options);
  const day = date.getDate();
  const suffix = day === 1 || day === 21 || day === 31 ? 'st'
               : day === 2 || day === 22 ? 'nd'
               : day === 3 || day === 23 ? 'rd'
               : 'th';
  return formatted.replace(/(\d+),/, `$1${suffix},`);
}

export async function getStaticPaths() {
  const queenPosts = await getCollection('posts-queen');
  const olaPosts = await getCollection('posts-olavea');
  const allPosts = [...queenPosts, ...olaPosts];

  // Collect all unique tags
  const tagsSet = new Set<string>();
  allPosts.forEach(post => {
    if (post.data.tags) {
      post.data.tags.split(',').forEach(tag => {
        const trimmedTag = tag.trim().toLowerCase();
        if (trimmedTag) {
          tagsSet.add(trimmedTag);
        }
      });
    }
  });

  // Create a page for each tag
  return Array.from(tagsSet).map(tag => ({
    params: { tag: tag.replace(/\s+/g, '-') },
    props: { tag },
  }));
}

const { tag } = Astro.props;

const queenPosts = await getCollection('posts-queen');
const olaPosts = await getCollection('posts-olavea');
const allPosts = [...queenPosts, ...olaPosts];

// Filter posts by tag
const taggedPosts = allPosts.filter(post => {
  if (!post.data.tags) return false;
  const postTags = post.data.tags.split(',').map(t => t.trim().toLowerCase());
  return postTags.includes(tag);
});

// Sort by date and format
const sortedPosts = taggedPosts.sort((a, b) => {
  const dateA = a.id.match(/(\d{4})\/(\d{2})\/(\d{2})/);
  const dateB = b.id.match(/(\d{4})\/(\d{2})\/(\d{2})/);
  if (dateA && dateB) {
    return new Date(`${dateB[1]}-${dateB[2]}-${dateB[3]}`).getTime() - new Date(`${dateA[1]}-${dateA[2]}-${dateA[3]}`).getTime();
  }
  return 0;
}).map((post) => {
  const dateMatch = post.id.match(/(\d{4})\/(\d{2})\/(\d{2})/);
  const dateStr = dateMatch ? `${dateMatch[1]}-${dateMatch[2]}-${dateMatch[3]}` : '';
  return {
    ...post,
    formattedDate: formatDate(dateStr),
  };
});

const title = `Posts tagged: "${tag}"`;
const description = `Learn more about "${tag}" by browsing the posts for the tag.`;
---

<BaseLayout title={title} description={description}>
  <main>
    <PageSection component="article">
      <PageSectionBreadcrumbs
        class="mt-4"
        items={[
          { label: 'Posts', to: '/posts/' },
          { label: tag }
        ]}
      />

      <PageSectionHeader hLevel={1} title={title} />

      <ContentList items={sortedPosts.map(post => ({
        to: `/${post.slug}/`,
        primary: post.data.title,
        secondary: post.formattedDate
      }))} />
    </PageSection>

    <PageSection component="footer">
      <Newsletter />
    </PageSection>
  </main>
</BaseLayout>
