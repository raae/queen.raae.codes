---
import BaseLayout from "../../layouts/BaseLayout.astro";
import SiteHeader from "../../components/SiteHeader.astro";
import PageSection from "../../components/PageSection.astro";
import PageSectionHeader from "../../components/PageSectionHeader.astro";
import Newsletter from "../../components/Newsletter.astro";
import { getAllPosts } from "../../lib/posts";

const TITLE = "Search all posts";

const allPosts = await getAllPosts();
const latestPosts = allPosts.slice(0, 3);
---

<BaseLayout title={TITLE}>
  <SiteHeader />
  <main>
    <PageSection component="header">
      <label for="search" class="sr-only">Search posts</label>
      <input
        autofocus
        type="search"
        name="search"
        id="search"
        class="font-medium w-full grow border-solid transition border-2 border-plum-500 focus:border-amber-500 focus-within:ring-1 focus-within:ring-amber-500"
        placeholder="Type to search..."
      />

      <div id="no-results" class="hidden mt-12 pl-1 text-lg font-bold" aria-live="polite">
        No results for <em id="search-term"></em>
      </div>

      <ul id="search-results" class="list-none px-0 my-0 space-y-0 mt-8" aria-live="polite"></ul>
    </PageSection>

    <PageSection>
      <PageSectionHeader badge="Latest posts" />
      <ul id="latest-posts" class="list-none px-0 my-0 space-y-0 mt-8">
        {
          latestPosts.map((post) => (
            <li class="relative border-0 border-b border-solid border-plum-900/10">
              <a
                href={post.slug}
                class="search-list-link block py-3 no-underline text-inherit transition-colors focus:outline-hidden"
              >
                <h3
                  class="search-list-title text-base my-0 font-extrabold text-plum-900"
                  style="font-family: var(--font-display);"
                >
                  {post.title}
                  <span class="search-list-arrow text-amber-500 inline-block ml-1 transition-transform"> →</span>
                </h3>
                <p
                  class="text-xs my-0 mt-1 font-semibold text-plum-400 uppercase"
                  style="font-family: var(--font-label); letter-spacing: 0.08em;"
                >
                  {post.dateFormatted}
                </p>
              </a>
            </li>
          ))
        }
      </ul>
    </PageSection>

    <PageSection component="footer">
      <Newsletter />
    </PageSection>
  </main>
</BaseLayout>

<script>
  import Fuse from "fuse.js";

  function escapeHtml(str: string): string {
    return str
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function highlightMatches(text: string, indices: readonly [number, number][]): string {
    if (!indices || indices.length === 0) return escapeHtml(text);

    let result = "";
    let lastIndex = 0;

    indices.forEach(([start, end]) => {
      result += escapeHtml(text.slice(lastIndex, start));
      result += "<mark>" + escapeHtml(text.slice(start, end + 1)) + "</mark>";
      lastIndex = end + 1;
    });

    result += escapeHtml(text.slice(lastIndex));
    return result;
  }

  async function initSearch() {
    const response = await fetch("/search/data.json");
    const searchData = await response.json();

    const FUSE_OPTIONS = {
      includeScore: true,
      ignoreLocation: true,
      includeMatches: true,
      shouldSort: true,
      useExtendedSearch: true,
      minMatchCharLength: 3,
      threshold: 0.4,
      keys: [
        "title",
        "tags.label",
        {
          name: "description",
          weight: 0.7,
        },
      ],
    };

    const fuse = new Fuse(searchData, FUSE_OPTIONS);
    const searchInput = document.getElementById("search") as HTMLInputElement;
    const resultsContainer = document.getElementById("search-results")!;
    const noResults = document.getElementById("no-results")!;
    const searchTermEl = document.getElementById("search-term")!;
    const latestPosts = document.getElementById("latest-posts")!;

    let debounceTimer: ReturnType<typeof setTimeout>;

    searchInput.addEventListener("input", (e) => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        const term = (e.target as HTMLInputElement).value.trim();

        if (term.length < 2) {
          resultsContainer.innerHTML = "";
          noResults.classList.add("hidden");
          latestPosts.parentElement!.classList.remove("hidden");
          return;
        }

        const results = fuse.search(term, { limit: 7 });

        if (results.length === 0) {
          resultsContainer.innerHTML = "";
          searchTermEl.textContent = term;
          noResults.classList.remove("hidden");
          latestPosts.parentElement!.classList.add("hidden");
        } else {
          noResults.classList.add("hidden");
          latestPosts.parentElement!.classList.add("hidden");

          resultsContainer.innerHTML = results
            .map((result) => {
              const item = result.item;
              let title = escapeHtml(item.title);
              let description = escapeHtml(item.description);

              // Highlight matches (replaces the escaped default above)
              result.matches?.forEach((match) => {
                if (match.key === "title") {
                  title = highlightMatches(item.title, match.indices);
                } else if (match.key === "description") {
                  description = highlightMatches(item.description, match.indices);
                }
              });

              const tagBadges = item.tags
                .map(
                  (tag) =>
                    `<span class="inline-flex items-center font-semibold text-plum-500 uppercase" style="font-family: var(--font-label); letter-spacing: 0.1em; font-size: 0.65rem;"><span class="text-amber-500">#</span>${escapeHtml(tag.label)}</span>`,
                )
                .join(" ");

              return `
              <li class="relative border-0 border-b border-solid" style="border-color: rgba(61,18,48,0.1);">
                <a href="${escapeHtml(item.slug)}" class="search-list-link block py-3 no-underline text-inherit transition-colors" style="color: inherit;">
                  <h3 class="search-list-title text-base my-0 font-extrabold" style="font-family: var(--font-display); color: var(--color-plum-900);">
                    ${title}
                    <span class="search-list-arrow" style="color: var(--color-amber-500); display: inline-block; margin-left: 0.25rem; transition: transform 0.2s;"> →</span>
                  </h3>
                  <p class="my-2 text-sm">${description}</p>
                  <div class="flex flex-wrap items-baseline gap-x-2 gap-y-1 mt-1">
                    <p class="my-0 font-semibold uppercase" style="font-family: var(--font-label); letter-spacing: 0.1em; font-size: 0.65rem; color: var(--color-plum-400);">
                      ${escapeHtml(item.date)}
                    </p>
                    <aside class="my-0 space-x-3">${tagBadges}</aside>
                  </div>
                </a>
              </li>
            `;
            })
            .join("");
        }
      }, 400);
    });
  }

  initSearch();
</script>

<style>
  .search-list-link:hover .search-list-title {
    text-decoration: underline;
    text-decoration-color: var(--color-amber-500);
    text-underline-offset: 3px;
  }
  .search-list-link:hover .search-list-arrow {
    color: var(--color-plum-500);
    transform: translateX(4px);
  }
</style>
