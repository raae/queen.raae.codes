---
import BaseLayout from '../../layouts/BaseLayout.astro';
import SiteHeader from '../../components/SiteHeader.astro';
import PageSection from '../../components/PageSection.astro';
import PageSectionHeader from '../../components/PageSectionHeader.astro';
import Newsletter from '../../components/Newsletter.astro';
import { getAllPosts } from '../../lib/posts';

const TITLE = 'Search all posts';

const allPosts = await getAllPosts();
const latestPosts = allPosts.slice(0, 3);

// Prepare search data for client-side Fuse.js
const searchData = allPosts.map(post => ({
  title: post.title,
  description: post.description,
  slug: post.slug,
  date: post.dateFormatted,
  tags: post.tags,
}));
---

<BaseLayout title={TITLE}>
  <SiteHeader />
  <main>
    <PageSection component="header">
      <label for="search" class="sr-only">Search posts</label>
      <input
        autofocus
        type="search"
        name="search"
        id="search"
        class="font-medium w-full flex-grow border-solid transition border-2 border-teal-900 focus:border-amber-500 focus-within:ring-1 focus-within:ring-amber-500"
        placeholder="Type to search..."
      />

      <div id="no-results" class="hidden mt-12 pl-1 text-lg font-bold">
        No results for <em id="search-term"></em>
      </div>

      <ul id="search-results" class="list-none px-0 my-0 -ml-1 space-y-4 mt-8"></ul>
    </PageSection>

    <PageSection>
      <PageSectionHeader badge="Latest posts" />
      <ul id="latest-posts" class="list-none px-0 my-0 -ml-1 space-y-4 mt-8">
        {latestPosts.map((post) => (
          <li class="mx-2 px-5 py-3 pb-4 relative border-0 border-l-4 border-solid border-amber-500 flex flex-col transition hover:bg-amber-400/30">
            <h3 class="text-base my-0 font-bold">
              <a href={post.slug} class="text-inherit no-underline focus:outline-none">
                <span class="absolute inset-0" aria-hidden="true" />
                {post.title}
              </a>
            </h3>
            <p class="text-xs my-0 order-first leading-8 font-medium text-teal-800 uppercase tracking-tight">
              {post.dateFormatted}
            </p>
          </li>
        ))}
      </ul>
    </PageSection>

    <PageSection component="footer">
      <Newsletter />
    </PageSection>
  </main>
</BaseLayout>

<script define:vars={{ searchData }}>
  // Import Fuse.js from CDN
  const script = document.createElement('script');
  script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js';
  script.onload = initSearch;
  document.head.appendChild(script);

  function initSearch() {
    const FUSE_OPTIONS = {
      includeScore: true,
      ignoreLocation: true,
      includeMatches: true,
      shouldSort: true,
      useExtendedSearch: true,
      minMatchCharLength: 3,
      threshold: 0.4,
      keys: [
        'title',
        'tags.label',
        {
          name: 'description',
          weight: 0.7,
        },
      ],
    };

    const fuse = new Fuse(searchData, FUSE_OPTIONS);
    const searchInput = document.getElementById('search');
    const resultsContainer = document.getElementById('search-results');
    const noResults = document.getElementById('no-results');
    const searchTermEl = document.getElementById('search-term');
    const latestPosts = document.getElementById('latest-posts');

    let debounceTimer;

    searchInput.addEventListener('input', (e) => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        const term = e.target.value.trim();

        if (term.length < 2) {
          resultsContainer.innerHTML = '';
          noResults.classList.add('hidden');
          latestPosts.parentElement.classList.remove('hidden');
          return;
        }

        const results = fuse.search(term, { limit: 7 });

        if (results.length === 0) {
          resultsContainer.innerHTML = '';
          searchTermEl.textContent = term;
          noResults.classList.remove('hidden');
          latestPosts.parentElement.classList.add('hidden');
        } else {
          noResults.classList.add('hidden');
          latestPosts.parentElement.classList.add('hidden');

          resultsContainer.innerHTML = results.map((result) => {
            const item = result.item;
            let title = item.title;
            let description = item.description;

            // Highlight matches
            result.matches?.forEach((match) => {
              if (match.key === 'title') {
                title = highlightMatches(item.title, match.indices);
              } else if (match.key === 'description') {
                description = highlightMatches(item.description, match.indices);
              }
            });

            const tagBadges = item.tags.map(tag =>
              `<span class="inline-flex items-center rounded-md px-2.5 py-0.5 bg-amber-100 text-xs font-medium text-brown-900">${tag.label}</span>`
            ).join(' ');

            return `
              <li class="mx-2 px-5 py-3 pb-4 relative border-0 border-l-4 border-solid border-amber-500 flex flex-col transition hover:bg-amber-400/30">
                <h3 class="text-base my-0 font-bold">
                  <a href="${item.slug}" class="text-inherit no-underline focus:outline-none">
                    <span class="absolute inset-0" aria-hidden="true"></span>
                    ${title}
                  </a>
                </h3>
                <p class="text-xs my-0 order-first leading-8 font-medium text-teal-800 uppercase tracking-tight">
                  ${item.date}
                </p>
                <p class="my-2 text-sm">${description}</p>
                <aside class="my-0 space-x-2">${tagBadges}</aside>
              </li>
            `;
          }).join('');
        }
      }, 400);
    });

    function highlightMatches(text, indices) {
      if (!indices || indices.length === 0) return text;

      let result = '';
      let lastIndex = 0;

      indices.forEach(([start, end]) => {
        result += text.slice(lastIndex, start);
        result += '<mark>' + text.slice(start, end + 1) + '</mark>';
        lastIndex = end + 1;
      });

      result += text.slice(lastIndex);
      return result;
    }
  }
</script>
