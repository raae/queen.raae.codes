---
import BaseLayout from "../layouts/BaseLayout.astro";
import SiteHeader from "../components/SiteHeader.astro";
import PageSection from "../components/PageSection.astro";
import PageSectionHeader from "../components/PageSectionHeader.astro";
import PageSectionBreadcrumbs from "../components/PageSectionBreadcrumbs.astro";
import Prose from "../components/Prose.astro";
import Badge from "../components/Badge.astro";
import Newsletter from "../components/Newsletter.astro";
import Posts from "../components/Posts.astro";
import { getAllPosts, getRelatedPosts, getAuthorInfo } from "../lib/posts";
import { getDisclaimers } from "../lib/disclaimers";
import { getOgImagePath, getOgImageUrl } from "../lib/og-image";
import siteMetadata from "../data/siteMetadata";

export async function getStaticPaths() {
  const allPosts = await getAllPosts();

  return allPosts.map((post) => {
    // Remove leading and trailing slashes for the slug param
    const slugParam = post.slug.replace(/^\/|\/$/g, "");
    return {
      params: { slug: slugParam },
      props: { post, allPosts },
    };
  });
}

const { post, allPosts } = Astro.props;
const { Content } = await post.render();

const relatedPosts = getRelatedPosts(post, allPosts, 3, 0.7);

// Look up brand disclaimers for this post's tags
const disclaimerMap = await getDisclaimers();
const disclaimers = post.tags.map((tag) => disclaimerMap.get(tag.label)).filter((d): d is string => !!d);

const authorInfo = getAuthorInfo(post.author);
const authorName = authorInfo.name;
const authorTwitter = authorInfo.twitter;

const ogImagePath = getOgImageUrl(post.slug, post.title, post.description);

// Schema.org structured data
const schema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: post.title,
  image: [`${import.meta.env.DEPLOY_PRIME_URL || siteMetadata.siteUrl}${ogImagePath}`],
  datePublished: post.dateISO,
  author: [
    {
      "@type": "Person",
      name: post.author === "JeanClaw2026" ? "Jean-Claw (AI)" : authorName,
      ...(authorTwitter ? { sameAs: authorTwitter } : {}),
    },
  ],
};
---

<BaseLayout
  title={post.title}
  description={post.description}
  image={ogImagePath}
  creator={post.author === "OlaVea" ? "@OlaHolstVea" : undefined}
>
  <script type="application/ld+json" set:html={JSON.stringify(schema, null, 2)} slot="head" />

  <SiteHeader />
  <main>
    <PageSection component="article">
      <PageSectionBreadcrumbs
        class="mt-4"
        items={[
          { label: "Posts", to: "/posts/" },
          { label: post.dateFormatted, datetime: post.date },
        ]}
      />

      <PageSectionHeader hLevel={1} title={post.title} />

      <aside class="space-x-2" style="font-family: var(--font-label); letter-spacing: 0.1em; font-size: 0.65rem;">
        <a href={authorInfo.slug} class="inline-flex items-center no-underline uppercase font-semibold text-plum-500 hover:text-[#f4511e] transition">
          By {authorName} {authorInfo.emoji}
        </a>
        {post.author === "JeanClaw2026" && (
          <span style="font-style: italic; text-transform: none; letter-spacing: normal; font-family: var(--font-body); font-weight: 400;" class="text-plum-400">
            — an AI agent running on <a href="https://openclaw.ai" class="underline decoration-amber-500 hover:text-[#f4511e] transition">OpenClaw</a>
          </span>
        )}
        {post.tags && post.tags.length > 0 && (
          post.tags.map(({ label, slug }) => (
            <Badge href={slug}>{label}</Badge>
          ))
        )}
      </aside>

      <Prose class="mt-12">
        <Content />
      </Prose>

      {
        disclaimers.length > 0 && (
          <aside class="relative pl-8 my-8 text-sm italic text-plum-400 before:content-['✦'] before:absolute before:left-0 before:top-0.5 before:text-base before:text-amber-500 before:not-italic">
            <ul class="space-y-1 list-none p-0">
              {disclaimers.map((disclaimer) => (
                <li>{disclaimer}</li>
              ))}
            </ul>
          </aside>
        )
      }
    </PageSection>

    <PageSection component="footer">
      <Newsletter tagline="Interested in more daily treasures like this one?" message="Sent directly to your inbox?" />
    </PageSection>

    {
      relatedPosts.length > 0 && (
        <PageSection>
          <PageSectionHeader hLevel={2} lead="You might also be interested in..." />
          <Posts posts={relatedPosts} />
        </PageSection>
      )
    }
  </main>
</BaseLayout>
