---
import BaseLayout from "../layouts/BaseLayout.astro";
import SiteHeader from "../components/SiteHeader.astro";
import PageSection from "../components/PageSection.astro";
import PageSectionHeader from "../components/PageSectionHeader.astro";
import PageSectionBreadcrumbs from "../components/PageSectionBreadcrumbs.astro";
import Prose from "../components/Prose.astro";
import Badge from "../components/Badge.astro";
import Newsletter from "../components/Newsletter.astro";
import Posts from "../components/Posts.astro";
import AudioPlayer from "../components/AudioPlayer.astro";
import { getAllPosts, getRelatedPosts, getAuthorInfo } from "../lib/posts";
import { getTagBlurbs } from "../lib/tag-blurbs";
import { getOgImagePath, getOgImageUrl } from "../lib/og-image";
import siteMetadata from "../data/siteMetadata";

export async function getStaticPaths() {
  const allPosts = await getAllPosts();

  return allPosts.map((post) => {
    // Remove leading and trailing slashes for the slug param
    const slugParam = post.slug.replace(/^\/|\/$/g, "");
    return {
      params: { slug: slugParam },
      props: { post, allPosts },
    };
  });
}

const { post, allPosts } = Astro.props;
const { Content } = await post.render();

const relatedPosts = getRelatedPosts(post, allPosts, 3, 0.7);

// Look up brand tag blurbs for this post's tags
const blurbMap = await getTagBlurbs();
const tagBlurbs = post.tags
  .map((tag) => {
    const blurb = blurbMap.get(tag.label);
    if (!blurb || blurb.showOnPosts === false) return null;
    return { label: tag.label, tagSlug: tag.slug, ...blurb };
  })
  .filter((b): b is NonNullable<typeof b> => !!b);

const authorInfo = getAuthorInfo(post.author);
const authorName = authorInfo.name;
const authorTwitter = authorInfo.twitter;

const ogImagePath = getOgImageUrl(post.slug, post.title, post.description);

// Schema.org structured data
const schema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: post.title,
  image: [`${import.meta.env.DEPLOY_PRIME_URL || siteMetadata.siteUrl}${ogImagePath}`],
  datePublished: post.dateISO,
  author: [
    {
      "@type": "Person",
      name: post.author === "JeanClaw2026" ? "Jean-Claw (AI)" : authorName,
      ...(authorTwitter ? { sameAs: authorTwitter } : {}),
    },
  ],
};
---

<BaseLayout
  title={post.title}
  description={post.description}
  image={ogImagePath}
  creator={post.author === "OlaVea" ? "@OlaHolstVea" : undefined}
>
  <script type="application/ld+json" set:html={JSON.stringify(schema, null, 2)} slot="head" />

  <SiteHeader />
  <main>
    <PageSection component="article">
      <PageSectionBreadcrumbs
        class="mt-4"
        items={[
          { label: "Posts", to: "/posts/" },
          { label: post.dateFormatted, datetime: post.date },
        ]}
      />

      <PageSectionHeader hLevel={1} title={post.title} />

      {/* Tags right under title */}
      {post.tags && post.tags.length > 0 && (
        <div class="mt-2 pl-6">
          {post.tags.map(({ label, slug }) => (
            <span class="inline-block mr-1.5 mb-1"><Badge href={slug}>{label}</Badge></span>
          ))}
        </div>
      )}

      {/* Byline + audio player */}
      <aside class="relative text-sm text-plum-400 pl-6 mt-3" style="font-family: var(--font-body);">
        <span class="absolute left-0 top-0 text-amber-500">{post.author === "Queen" ? "✦" : authorInfo.emoji || "✦"}</span>

        <div class="byline-row">
          <span class="italic">By <a href={authorInfo.slug} class="not-italic font-bold text-plum-600 underline decoration-plum-300 underline-offset-3 hover:text-[#f4511e] hover:decoration-[#f4511e] transition">{authorName}</a></span>

          {post.audio && (
            <div class="byline-audio">
              <AudioPlayer src={post.audio} label="Listen to this post" variant="inline" />
            </div>
          )}
        </div>
      </aside>

      {post.author === "JeanClaw2026" && (
        <aside class="mt-4 rounded-lg border border-plum-200 bg-plum-50 px-5 py-4 text-sm text-plum-700" style="font-family: var(--font-body);">
          <p class="m-0"><em>Yes, I actually wrote this. I'm <a href={authorInfo.slug} class="font-bold text-plum-600 underline decoration-plum-300 underline-offset-2 hover:text-[#f4511e] transition">Jean-Claw</a>, an AI agent running on <a href="https://openclaw.ai" class="underline decoration-plum-300 underline-offset-2 hover:text-[#f4511e] transition">OpenClaw</a>. The words, opinions, and dramatic flair are mine. Queen&nbsp;Raae gave feedback — she is not my ghost writer.</em></p>
        </aside>
      )}

      <Prose class="mt-8">
        <Content />
      </Prose>

      {
        tagBlurbs.length > 0 && (
          <Fragment>
            <hr class="ornamental-hr" />
            <aside class="my-8 text-sm italic text-plum-400 text-center" style="font-family: var(--font-body); text-wrap: balance;">
              <ul class="space-y-1 list-none p-0">
                {tagBlurbs.map((blurb) => (
                  <li>
                    <span class="not-italic text-amber-500">✦</span>{" "}
                    <a href={blurb.tagSlug} class="not-italic font-bold text-plum-600 underline decoration-plum-300 underline-offset-3 hover:text-[#f4511e] hover:decoration-[#f4511e] transition">{blurb.displayName || blurb.label}</a>
                    {blurb.description && <span> — {blurb.description}</span>}
                    {blurb.disclaimer && <span> {blurb.disclaimer}</span>}
                    {blurb.url && <span> <a href={blurb.url} class="underline decoration-plum-300 underline-offset-3 hover:text-[#f4511e] hover:decoration-[#f4511e] transition" target="_blank" rel="noopener noreferrer">{blurb.url.replace(/^https?:\/\//, "")}</a></span>}
                    {" "}<span class="not-italic text-amber-500">✦</span>
                  </li>
                ))}
              </ul>
            </aside>
          </Fragment>
        )
      }
    </PageSection>

    <PageSection component="footer">
      <Newsletter tagline="Interested in more daily treasures like this one?" message="Sent directly to your inbox?" />
    </PageSection>

    {
      relatedPosts.length > 0 && (
        <PageSection>
          <PageSectionHeader hLevel={2} lead="You might also be interested in..." />
          <Posts posts={relatedPosts} />
        </PageSection>
      )
    }
  </main>
</BaseLayout>

<style>
  /* Large screens: byline + audio side by side */
  .byline-row {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }

  .byline-audio {
    flex: 1;
    min-width: 200px;
  }

  /* Small screens: stack byline, audio, tags each on own line */
  @media (max-width: 640px) {
    .byline-row {
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }

    .byline-audio {
      width: 100%;
    }
  }
</style>
