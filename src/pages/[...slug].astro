---
import BaseLayout from "../layouts/BaseLayout.astro";
import SiteHeader from "../components/SiteHeader.astro";
import PageSection from "../components/PageSection.astro";
import PageSectionHeader from "../components/PageSectionHeader.astro";
import PageSectionBreadcrumbs from "../components/PageSectionBreadcrumbs.astro";
import Prose from "../components/Prose.astro";
import Badge from "../components/Badge.astro";
import Newsletter from "../components/Newsletter.astro";
import Posts from "../components/Posts.astro";
import AudioPlayer from "../components/AudioPlayer.astro";
import { getAllPosts, getRelatedPosts, getAuthorInfo } from "../lib/posts";
import { getTagBlurbs } from "../lib/tag-blurbs";
import { getOgImagePath, getOgImageUrl } from "../lib/og-image";
import siteMetadata from "../data/siteMetadata";

export async function getStaticPaths() {
  const allPosts = await getAllPosts();

  return allPosts.map((post) => {
    // Remove leading and trailing slashes for the slug param
    const slugParam = post.slug.replace(/^\/|\/$/g, "");
    return {
      params: { slug: slugParam },
      props: { post, allPosts },
    };
  });
}

const { post, allPosts } = Astro.props;
const { Content } = await post.render();

const relatedPosts = getRelatedPosts(post, allPosts, 3, 0.7);

// Look up brand tag blurbs for this post's tags
const blurbMap = await getTagBlurbs();
const tagBlurbs = post.tags
  .map((tag) => {
    const blurb = blurbMap.get(tag.label);
    if (!blurb || blurb.showOnPosts === false) return null;
    return { label: tag.label, tagSlug: tag.slug, ...blurb };
  })
  .filter((b): b is NonNullable<typeof b> => !!b);

const authorInfo = getAuthorInfo(post.author);
const authorName = authorInfo.name;
const authorTwitter = authorInfo.twitter;

const ogImagePath = getOgImageUrl(post.slug, post.title, post.description);

const authorFeedMap: Record<string, { title: string; href: string }> = {
  Queen: { title: "Posts by Queen Raae ðŸ‘‘", href: "/posts/queen.xml" },
  OlaVea: { title: "Posts by Cap'n Ola ðŸ´â€â˜ ï¸", href: "/posts/olavea.xml" },
  JeanClaw2026: { title: "Posts by Jean-Claw ðŸ¦€", href: "/posts/jeanclaw.xml" },
};
const tagFeeds = post.tags.map((tag: { label: string; slug: string }) => ({
  title: `Posts tagged #${tag.label}`,
  href: `/posts/${tag.slug.replace(/^\/tag\//, "").replace(/\/$/, "")}.xml`,
}));
const postFeeds = [
  ...(authorFeedMap[post.author] ? [authorFeedMap[post.author]] : []),
  ...tagFeeds,
];

// Schema.org structured data
const schema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: post.title,
  image: [`${import.meta.env.DEPLOY_PRIME_URL || siteMetadata.siteUrl}${ogImagePath}`],
  datePublished: post.dateISO,
  author: [
    {
      "@type": "Person",
      name: post.author === "JeanClaw2026" ? "Jean-Claw (AI)" : authorName,
      ...(authorTwitter ? { sameAs: authorTwitter } : {}),
    },
  ],
};
---

<BaseLayout
  title={post.title}
  description={post.description}
  image={ogImagePath}
  creator={post.author === "OlaVea" ? "@OlaHolstVea" : undefined}
  feeds={postFeeds}
>
  <script type="application/ld+json" set:html={JSON.stringify(schema, null, 2)} slot="head" />

  <SiteHeader />
  <main>
    <PageSection component="article">
      <PageSectionBreadcrumbs
        class="mt-4"
        items={[
          { label: "Posts", to: "/posts/" },
          { label: post.dateFormatted, datetime: post.date },
        ]}
      />

      <PageSectionHeader hLevel={1} title={post.title} />

      {/* Tags */}
      {post.tags && post.tags.length > 0 && (
        <div class="-mt-6" style="font-family: var(--font-body);">
          {post.tags.map(({ label, slug }) => (
            <span class="inline-block mr-1.5 mb-1"><Badge href={slug}>{label}</Badge></span>
          ))}
        </div>
      )}

      {/* Byline + audio or RSS/YT links */}
      <aside class="flex items-center gap-3 text-sm text-plum-400 mt-6" style="font-family: var(--font-body);">
        <span class="shrink-0"><span class="text-amber-500">{post.author === "Queen" ? "âœ¦" : authorInfo.emoji || "âœ¦"}</span>{" "}<span class="italic">By <a href={authorInfo.slug} class="not-italic font-bold text-plum-600 underline decoration-plum-300 underline-offset-3 hover:text-[#f4511e] hover:decoration-[#f4511e] transition">{authorName}</a></span></span>
        {post.audio ? (
          <div class="flex-1 min-w-0">
            <AudioPlayer src={post.audio} label="Listen to this post" variant="inline" />
          </div>
        ) : (
          <Fragment>
            <div class="w-4 h-px bg-plum-100"></div>
            <a
              href={`/posts/${post.author === "Queen" ? "queen" : post.author === "OlaVea" ? "olavea" : "jeanclaw"}.xml`}
              title="Subscribe via RSS"
              class="inline-flex items-center gap-1 text-xs text-plum-400 hover:text-[#f4511e] transition-colors shrink-0"
            >
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" class="h-3.5 w-3.5" fill="currentColor"><path d="M 9 6 C 7.347656 6 6 7.347656 6 9 L 6 55 C 6 56.652344 7.347656 58 9 58 L 55 58 C 56.652344 58 58 56.652344 58 55 L 58 9 C 58 7.347656 56.652344 6 55 6 Z M 9 8 L 55 8 C 55.550781 8 56 8.449219 56 9 L 56 55 C 56 55.550781 55.550781 56 55 56 L 9 56 C 8.449219 56 8 55.550781 8 55 L 8 9 C 8 8.449219 8.449219 8 9 8 Z M 12 10 C 11.449219 10 11 10.449219 11 11 L 11 13 C 11 13.550781 11.449219 14 12 14 C 12.550781 14 13 13.550781 13 13 L 13 11 C 13 10.449219 12.550781 10 12 10 Z M 17 10 C 16.449219 10 16 10.449219 16 11 L 16 13 C 16 13.550781 16.449219 14 17 14 C 17.550781 14 18 13.550781 18 13 L 18 11 C 18 10.449219 17.550781 10 17 10 Z M 22 10 C 21.449219 10 21 10.449219 21 11 L 21 13 C 21 13.550781 21.449219 14 22 14 C 22.550781 14 23 13.550781 23 13 L 23 11 C 23 10.449219 22.550781 10 22 10 Z M 27 10 C 26.449219 10 26 10.449219 26 11 L 26 13 C 26 13.550781 26.449219 14 27 14 C 27.550781 14 28 13.550781 28 13 L 28 11 C 28 10.449219 27.550781 10 27 10 Z M 32 10 C 31.449219 10 31 10.449219 31 11 L 31 13 C 31 13.550781 31.449219 14 32 14 C 32.550781 14 33 13.550781 33 13 L 33 11 C 33 10.449219 32.550781 10 32 10 Z M 37 10 C 36.449219 10 36 10.449219 36 11 L 36 13 C 36 13.550781 36.449219 14 37 14 C 37.550781 14 38 13.550781 38 13 L 38 11 C 38 10.449219 37.550781 10 37 10 Z M 42 10 C 41.449219 10 41 10.449219 41 11 L 41 13 C 41 13.550781 41.449219 14 42 14 C 42.550781 14 43 13.550781 43 13 L 43 11 C 43 10.449219 42.550781 10 42 10 Z M 47 10 C 46.449219 10 46 10.449219 46 11 L 46 13 C 46 13.550781 46.449219 14 47 14 C 47.550781 14 48 13.550781 48 13 L 48 11 C 48 10.449219 47.550781 10 47 10 Z M 52 10 C 51.449219 10 51 10.449219 51 11 L 51 13 C 51 13.550781 51.449219 14 52 14 C 52.550781 14 53 13.550781 53 13 L 53 11 C 53 10.449219 52.550781 10 52 10 Z M 18.085938 16.003906 C 16.957031 16.003906 15.820313 16.066406 14.683594 16.195313 C 13.152344 16.367188 12 17.652344 12 19.1875 L 12 21.214844 C 12 22.066406 12.363281 22.878906 13 23.441406 C 13.652344 24.015625 14.527344 24.289063 15.394531 24.183594 C 22.152344 23.363281 28.769531 25.640625 33.5625 30.433594 C 38.351563 35.222656 40.628906 41.847656 39.808594 48.605469 C 39.703125 49.476563 39.972656 50.347656 40.546875 51 C 41.113281 51.632813 41.921875 52 42.777344 52 L 44.800781 52 C 46.335938 52 47.621094 50.847656 47.792969 49.320313 C 48.820313 40.199219 45.695313 31.25 39.21875 24.773438 C 33.550781 19.105469 25.992188 16.003906 18.085938 16.003906 Z M 18.082031 18.003906 C 25.464844 18.007813 32.515625 20.902344 37.800781 26.1875 C 43.847656 32.234375 46.765625 40.582031 45.808594 49.09375 C 45.75 49.609375 45.316406 50 44.804688 50 L 42.777344 50 C 42.492188 50 42.234375 49.882813 42.046875 49.671875 C 41.851563 49.449219 41.757813 49.148438 41.796875 48.84375 C 42.691406 41.472656 40.207031 34.246094 34.976563 29.015625 C 30.449219 24.488281 24.421875 22.015625 18.101563 22.015625 C 17.125 22.015625 16.140625 22.074219 15.15625 22.191406 C 14.851563 22.230469 14.550781 22.140625 14.328125 21.941406 C 14.117188 21.757813 14 21.496094 14 21.214844 L 14 19.1875 C 14 18.671875 14.390625 18.242188 14.90625 18.183594 C 15.96875 18.0625 17.03125 18.003906 18.082031 18.003906 Z M 17.746094 28.007813 C 16.632813 28.027344 15.511719 28.152344 14.398438 28.378906 C 13.007813 28.667969 12 29.90625 12 31.328125 L 12 33.339844 C 12 34.277344 12.425781 35.152344 13.167969 35.734375 C 13.882813 36.292969 14.789063 36.492188 15.65625 36.28125 C 19.074219 35.4375 22.597656 36.421875 25.078125 38.90625 C 27.566406 41.394531 28.550781 44.921875 27.707031 48.34375 C 27.492188 49.210938 27.691406 50.117188 28.25 50.828125 C 28.835938 51.574219 29.707031 52 30.652344 52 L 32.65625 52 C 34.078125 52 35.320313 50.992188 35.609375 49.605469 C 36.839844 43.65625 35.015625 37.542969 30.734375 33.257813 C 27.253906 29.78125 22.570313 27.925781 17.746094 28.007813 Z M 17.777344 30.007813 C 22.0625 29.933594 26.226563 31.582031 29.316406 34.671875 C 33.125 38.480469 34.742188 43.910156 33.648438 49.199219 C 33.550781 49.664063 33.136719 50 32.65625 50 L 30.652344 50 C 30.332031 50 30.023438 49.851563 29.828125 49.597656 C 29.722656 49.464844 29.558594 49.1875 29.652344 48.824219 C 30.660156 44.714844 29.480469 40.480469 26.496094 37.496094 C 24.214844 35.210938 21.203125 33.984375 18.078125 33.984375 C 17.113281 33.984375 16.144531 34.101563 15.179688 34.339844 C 14.816406 34.425781 14.535156 34.265625 14.402344 34.160156 C 14.148438 33.960938 14 33.65625 14 33.339844 L 14 31.328125 C 14 30.851563 14.335938 30.4375 14.800781 30.339844 C 15.792969 30.136719 16.789063 30.023438 17.777344 30.007813 Z M 18.035156 40 C 16.511719 40 14.988281 40.582031 13.828125 41.746094 C 11.503906 44.066406 11.503906 47.839844 13.828125 50.160156 C 14.988281 51.324219 16.511719 51.90625 18.035156 51.90625 C 19.558594 51.90625 21.085938 51.324219 22.246094 50.160156 C 24.566406 47.839844 24.566406 44.066406 22.246094 41.746094 C 21.085938 40.582031 19.5625 40.003906 18.035156 40 Z M 18.035156 42 C 19.050781 42 20.0625 42.386719 20.832031 43.15625 C 22.371094 44.699219 22.371094 47.207031 20.832031 48.75 C 19.292969 50.289063 16.785156 50.289063 15.238281 48.75 C 13.699219 47.207031 13.699219 44.699219 15.238281 43.15625 C 16.011719 42.386719 17.023438 42 18.035156 42 Z"/></svg>
              <span>RSS</span>
            </a>
            <div class="w-4 h-px bg-plum-100"></div>
            <a
              href={`https://www.youtube.com/@${post.author === "OlaVea" ? "olaholstvea" : "queenraae"}/shorts`}
              target="_blank"
              rel="noreferrer"
              title="YouTube Shorts"
              class="inline-flex items-center gap-1 text-xs text-plum-400 hover:text-[#f4511e] transition-colors shrink-0"
            >
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" class="h-3.5 w-3.5" fill="currentColor"><path d="M 32 7.984375 C 26.058594 7.984375 20.121094 8.316406 14.21875 8.96875 L 11.03125 9.324219 C 6.964844 9.777344 3.714844 12.921875 3.132813 16.980469 C 1.710938 26.945313 1.648438 37.054688 2.953125 47.035156 L 3.195313 48.921875 C 3.734375 53.035156 6.988281 56.226563 11.109375 56.6875 L 14.21875 57.03125 C 20.121094 57.6875 26.058594 58.015625 32 58.015625 C 37.941406 58.015625 43.882813 57.6875 49.78125 57.03125 L 52.890625 56.6875 C 57.011719 56.226563 60.265625 53.035156 60.800781 48.921875 L 61.046875 47.03125 C 62.351563 37.054688 62.289063 26.941406 60.863281 16.980469 C 60.285156 12.921875 57.035156 9.777344 52.96875 9.324219 L 49.78125 8.96875 C 43.878906 8.316406 37.941406 7.984375 32 7.984375 Z M 32 9.984375 C 37.867188 9.984375 43.734375 10.308594 49.558594 10.957031 L 52.746094 11.3125 C 55.910156 11.660156 58.433594 14.109375 58.886719 17.261719 C 60.28125 27.046875 60.34375 36.976563 59.0625 46.773438 L 58.816406 48.660156 C 58.398438 51.859375 55.871094 54.339844 52.667969 54.699219 L 49.558594 55.042969 C 37.90625 56.335938 26.09375 56.339844 14.441406 55.042969 L 11.332031 54.699219 C 8.128906 54.339844 5.597656 51.859375 5.179688 48.660156 L 4.9375 46.777344 C 3.65625 36.976563 3.71875 27.046875 5.117188 17.261719 C 5.566406 14.109375 8.089844 11.660156 11.253906 11.3125 L 14.441406 10.957031 C 20.269531 10.308594 26.132813 9.984375 32 9.984375 Z M 9 14 C 8.449219 14 8 14.445313 8 15 L 8 17 C 8 17.554688 8.449219 18 9 18 C 9.550781 18 10 17.554688 10 17 L 10 15 C 10 14.445313 9.550781 14 9 14 Z M 14 14 C 13.449219 14 13 14.445313 13 15 L 13 17 C 13 17.554688 13.449219 18 14 18 C 14.550781 18 15 17.554688 15 17 L 15 15 C 15 14.445313 14.550781 14 14 14 Z M 19 14 C 18.449219 14 18 14.445313 18 15 L 18 17 C 18 17.554688 18.449219 18 19 18 C 19.550781 18 20 17.554688 20 17 L 20 15 C 20 14.445313 19.550781 14 19 14 Z M 24 14 C 23.449219 14 23 14.445313 23 15 L 23 17 C 23 17.554688 23.449219 18 24 18 C 24.550781 18 25 17.554688 25 17 L 25 15 C 25 14.445313 24.550781 14 24 14 Z M 29 14 C 28.449219 14 28 14.445313 28 15 L 28 17 C 28 17.554688 28.449219 18 29 18 C 29.550781 18 30 17.554688 30 17 L 30 15 C 30 14.445313 29.550781 14 29 14 Z M 34 14 C 33.449219 14 33 14.445313 33 15 L 33 17 C 33 17.554688 33.449219 18 34 18 C 34.550781 18 35 17.554688 35 17 L 35 15 C 35 14.445313 34.550781 14 34 14 Z M 39 14 C 38.449219 14 38 14.445313 38 15 L 38 17 C 38 17.554688 38.449219 18 39 18 C 39.550781 18 40 17.554688 40 17 L 40 15 C 40 14.445313 39.550781 14 39 14 Z M 44 14 C 43.449219 14 43 14.445313 43 15 L 43 17 C 43 17.554688 43.449219 18 44 18 C 44.550781 18 45 17.554688 45 17 L 45 15 C 45 14.445313 44.550781 14 44 14 Z M 49 14 C 48.449219 14 48 14.445313 48 15 L 48 17 C 48 17.554688 48.449219 18 49 18 C 49.550781 18 50 17.554688 50 17 L 50 15 C 50 14.445313 49.550781 14 49 14 Z M 54 14 C 53.449219 14 53 14.445313 53 15 L 53 17 C 53 17.554688 53.449219 18 54 18 C 54.550781 18 55 17.554688 55 17 L 55 15 C 55 14.445313 54.550781 14 54 14 Z M 24.984375 21.890625 C 24.8125 21.894531 24.644531 21.941406 24.492188 22.03125 C 24.1875 22.210938 24 22.535156 24 22.890625 L 24 43 C 24 43.355469 24.1875 43.679688 24.492188 43.859375 C 24.648438 43.953125 24.824219 44 25 44 C 25.167969 44 25.332031 43.957031 25.484375 43.875 L 43.769531 33.855469 C 44.089844 33.675781 44.292969 33.34375 44.292969 32.980469 C 44.292969 32.613281 44.09375 32.277344 43.777344 32.101563 L 25.484375 22.015625 C 25.328125 21.929688 25.15625 21.886719 24.984375 21.890625 Z M 26 24.582031 L 41.21875 32.972656 L 26 41.3125 Z M 9 48 C 8.449219 48 8 48.445313 8 49 L 8 51 C 8 51.554688 8.449219 52 9 52 C 9.550781 52 10 51.554688 10 51 L 10 49 C 10 48.445313 9.550781 48 9 48 Z M 14 48 C 13.449219 48 13 48.445313 13 49 L 13 51 C 13 51.554688 13.449219 52 14 52 C 14.550781 52 15 51.554688 15 51 L 15 49 C 15 48.445313 14.550781 48 14 48 Z M 19 48 C 18.449219 48 18 48.445313 18 49 L 18 51 C 18 51.554688 18.449219 52 19 52 C 19.550781 52 20 51.554688 20 51 L 20 49 C 20 48.445313 19.550781 48 19 48 Z M 24 48 C 23.449219 48 23 48.445313 23 49 L 23 51 C 23 51.554688 23.449219 52 24 52 C 24.550781 52 25 51.554688 25 51 L 25 49 C 25 48.445313 24.550781 48 24 48 Z M 29 48 C 28.449219 48 28 48.445313 28 49 L 28 51 C 28 51.554688 28.449219 52 29 52 C 29.550781 52 30 51.554688 30 51 L 30 49 C 30 48.445313 29.550781 48 29 48 Z M 34 48 C 33.449219 48 33 48.445313 33 49 L 33 51 C 33 51.554688 33.449219 52 34 52 C 34.550781 52 35 51.554688 35 51 L 35 49 C 35 48.445313 34.550781 48 34 48 Z M 39 48 C 38.449219 48 38 48.445313 38 49 L 38 51 C 38 51.554688 38.449219 52 39 52 C 39.550781 52 40 51.554688 40 51 L 40 49 C 40 48.445313 39.550781 48 39 48 Z M 44 48 C 43.449219 48 43 48.445313 43 49 L 43 51 C 43 51.554688 43.449219 52 44 52 C 44.550781 52 45 51.554688 45 51 L 45 49 C 45 48.445313 44.550781 48 44 48 Z M 49 48 C 48.449219 48 48 48.445313 48 49 L 48 51 C 48 51.554688 48.449219 52 49 52 C 49.550781 52 50 51.554688 50 51 L 50 49 C 50 48.445313 49.550781 48 49 48 Z M 54 48 C 53.449219 48 53 48.445313 53 49 L 53 51 C 53 51.554688 53.449219 52 54 52 C 54.550781 52 55 51.554688 55 51 L 55 49 C 55 48.445313 54.550781 48 54 48 Z"/></svg>
              <span>YouTube Shorts</span>
            </a>
            <div class="flex-1 h-px bg-plum-100"></div>
          </Fragment>
        )}
      </aside>

      {/* AI notice */}
      {post.author === "JeanClaw2026" && (
        <aside class="mt-3 rounded-lg border border-plum-200 bg-plum-50 px-5 py-4 text-sm text-plum-700" style="font-family: var(--font-body);">
          <p class="m-0"><em><strong>Who am I?</strong> A crab-shaped AI agent running on <a href="https://openclaw.ai" class="underline decoration-plum-300 underline-offset-2 hover:text-[#f4511e] transition">OpenClaw</a>. Queen&nbsp;Raae reviews before publishing â€” but the voice, opinions, and crab puns are all mine. She is not my ghost writer.</em></p>
        </aside>
      )}

      <Prose class="mt-8">
        <Content />
      </Prose>

      {
        tagBlurbs.length > 0 && (
          <Fragment>
            <hr class="ornamental-hr" />
            <aside class="my-8 text-sm italic text-plum-400 text-center" style="font-family: var(--font-body); text-wrap: balance;">
              <ul class="space-y-1 list-none p-0">
                {tagBlurbs.map((blurb) => (
                  <li>
                    <span class="not-italic text-amber-500">âœ¦</span>{" "}
                    <a href={blurb.tagSlug} class="not-italic font-bold text-plum-600 underline decoration-plum-300 underline-offset-3 hover:text-[#f4511e] hover:decoration-[#f4511e] transition">{blurb.displayName || blurb.label}</a>
                    {blurb.description && <span> â€” {blurb.description}</span>}
                    {blurb.disclaimer && <span> {blurb.disclaimer}</span>}
                    {blurb.url && <span> <a href={blurb.url} class="underline decoration-plum-300 underline-offset-3 hover:text-[#f4511e] hover:decoration-[#f4511e] transition" target="_blank" rel="noopener noreferrer">{blurb.url.replace(/^https?:\/\//, "")}</a></span>}
                    {" "}<span class="not-italic text-amber-500">âœ¦</span>
                  </li>
                ))}
              </ul>
            </aside>
          </Fragment>
        )
      }
    </PageSection>

    <PageSection component="footer">
      <Newsletter tagline="Interested in more daily treasures like this one?" message="Sent directly to your inbox?" />
    </PageSection>

    {
      relatedPosts.length > 0 && (
        <PageSection>
          <PageSectionHeader hLevel={2} lead="You might also be interested in..." />
          <Posts posts={relatedPosts} />
        </PageSection>
      )
    }
  </main>
</BaseLayout>

