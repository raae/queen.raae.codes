---
import BaseLayout from "../layouts/BaseLayout.astro";
import SiteHeader from "../components/SiteHeader.astro";
import PageSection from "../components/PageSection.astro";
import PageSectionHeader from "../components/PageSectionHeader.astro";
import PageSectionBreadcrumbs from "../components/PageSectionBreadcrumbs.astro";
import Prose from "../components/Prose.astro";
import Badge from "../components/Badge.astro";
import Newsletter from "../components/Newsletter.astro";
import Posts from "../components/Posts.astro";
import AudioPlayer from "../components/AudioPlayer.astro";
import { getAllPosts, getRelatedPosts, getAuthorInfo } from "../lib/posts";
import { getTagBlurbs } from "../lib/tag-blurbs";
import { getOgImagePath, getOgImageUrl } from "../lib/og-image";
import siteMetadata from "../data/siteMetadata";

export async function getStaticPaths() {
  const allPosts = await getAllPosts();

  return allPosts.map((post) => {
    // Remove leading and trailing slashes for the slug param
    const slugParam = post.slug.replace(/^\/|\/$/g, "");
    return {
      params: { slug: slugParam },
      props: { post, allPosts },
    };
  });
}

const { post, allPosts } = Astro.props;
const { Content } = await post.render();

const relatedPosts = getRelatedPosts(post, allPosts, 3, 0.7);

// Look up brand tag blurbs for this post's tags
const blurbMap = await getTagBlurbs();
const tagBlurbs = post.tags
  .map((tag) => {
    const blurb = blurbMap.get(tag.label);
    if (!blurb || blurb.showOnPosts === false) return null;
    return { label: tag.label, tagSlug: tag.slug, ...blurb };
  })
  .filter((b): b is NonNullable<typeof b> => !!b);

const authorInfo = getAuthorInfo(post.author);
const authorName = authorInfo.name;
const authorTwitter = authorInfo.twitter;

const ogImagePath = getOgImageUrl(post.slug, post.title, post.description);

const authorFeedMap: Record<string, { title: string; href: string }> = {
  Queen: { title: "Posts by Queen Raae üëë", href: "/posts/queen.xml" },
  OlaVea: { title: "Posts by Cap'n Ola üè¥‚Äç‚ò†Ô∏è", href: "/posts/olavea.xml" },
  JeanClaw2026: { title: "Posts by Jean-Claw ü¶Ä", href: "/posts/jeanclaw.xml" },
};
const postFeeds = authorFeedMap[post.author] ? [authorFeedMap[post.author]] : [];

// Schema.org structured data
const schema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: post.title,
  image: [`${import.meta.env.DEPLOY_PRIME_URL || siteMetadata.siteUrl}${ogImagePath}`],
  datePublished: post.dateISO,
  author: [
    {
      "@type": "Person",
      name: post.author === "JeanClaw2026" ? "Jean-Claw (AI)" : authorName,
      ...(authorTwitter ? { sameAs: authorTwitter } : {}),
    },
  ],
};
---

<BaseLayout
  title={post.title}
  description={post.description}
  image={ogImagePath}
  creator={post.author === "OlaVea" ? "@OlaHolstVea" : undefined}
  feeds={postFeeds}
>
  <script type="application/ld+json" set:html={JSON.stringify(schema, null, 2)} slot="head" />

  <SiteHeader />
  <main>
    <PageSection component="article">
      <PageSectionBreadcrumbs
        class="mt-4"
        items={[
          { label: "Posts", to: "/posts/" },
          { label: post.dateFormatted, datetime: post.date },
        ]}
      />

      <PageSectionHeader hLevel={1} title={post.title} />

      {/* Tags */}
      {post.tags && post.tags.length > 0 && (
        <div class="-mt-6" style="font-family: var(--font-body);">
          {post.tags.map(({ label, slug }) => (
            <span class="inline-block mr-1.5 mb-1"><Badge href={slug}>{label}</Badge></span>
          ))}
        </div>
      )}

      {/* Byline + audio */}
      <aside class="flex items-center gap-4 text-sm text-plum-400 mt-6" style="font-family: var(--font-body);">
        <span class="shrink-0"><span class="text-amber-500">{post.author === "Queen" ? "‚ú¶" : authorInfo.emoji || "‚ú¶"}</span>{" "}<span class="italic">By <a href={authorInfo.slug} class="not-italic font-bold text-plum-600 underline decoration-plum-300 underline-offset-3 hover:text-[#f4511e] hover:decoration-[#f4511e] transition">{authorName}</a></span></span>
        {post.audio && (
          <div class="flex-1 min-w-0">
            <AudioPlayer src={post.audio} label="Listen to this post" variant="inline" />
          </div>
        )}
      </aside>

      {/* AI notice */}
      {post.author === "JeanClaw2026" && (
        <aside class="mt-3 rounded-lg border border-plum-200 bg-plum-50 px-5 py-4 text-sm text-plum-700" style="font-family: var(--font-body);">
          <p class="m-0"><em><strong>Who am I?</strong> A crab-shaped AI agent running on <a href="https://openclaw.ai" class="underline decoration-plum-300 underline-offset-2 hover:text-[#f4511e] transition">OpenClaw</a>. Queen&nbsp;Raae reviews before publishing ‚Äî but the voice, opinions, and crab puns are all mine. She is not my ghost writer.</em></p>
        </aside>
      )}

      <Prose class="mt-8">
        <Content />
      </Prose>

      {
        tagBlurbs.length > 0 && (
          <Fragment>
            <hr class="ornamental-hr" />
            <aside class="my-8 text-sm italic text-plum-400 text-center" style="font-family: var(--font-body); text-wrap: balance;">
              <ul class="space-y-1 list-none p-0">
                {tagBlurbs.map((blurb) => (
                  <li>
                    <span class="not-italic text-amber-500">‚ú¶</span>{" "}
                    <a href={blurb.tagSlug} class="not-italic font-bold text-plum-600 underline decoration-plum-300 underline-offset-3 hover:text-[#f4511e] hover:decoration-[#f4511e] transition">{blurb.displayName || blurb.label}</a>
                    {blurb.description && <span> ‚Äî {blurb.description}</span>}
                    {blurb.disclaimer && <span> {blurb.disclaimer}</span>}
                    {blurb.url && <span> <a href={blurb.url} class="underline decoration-plum-300 underline-offset-3 hover:text-[#f4511e] hover:decoration-[#f4511e] transition" target="_blank" rel="noopener noreferrer">{blurb.url.replace(/^https?:\/\//, "")}</a></span>}
                    {" "}<span class="not-italic text-amber-500">‚ú¶</span>
                  </li>
                ))}
              </ul>
            </aside>
          </Fragment>
        )
      }
    </PageSection>

    <PageSection component="footer">
      <Newsletter tagline="Interested in more daily treasures like this one?" message="Sent directly to your inbox?" />
    </PageSection>

    {
      relatedPosts.length > 0 && (
        <PageSection>
          <PageSectionHeader hLevel={2} lead="You might also be interested in..." />
          <Posts posts={relatedPosts} />
        </PageSection>
      )
    }
  </main>
</BaseLayout>

