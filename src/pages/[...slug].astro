---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  const queenPosts = await getCollection('posts-queen');
  const olaPosts = await getCollection('posts-olavea');
  const allPosts = [...queenPosts, ...olaPosts];

  return allPosts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

// Extract date from slug (format: YYYY/MM/DD-title)
const dateMatch = post.id.match(/(\d{4})\/(\d{2})\/(\d{2})/);
const dateStr = dateMatch ? `${dateMatch[1]}-${dateMatch[2]}-${dateMatch[3]}` : '';
const dateObj = dateMatch ? new Date(`${dateMatch[1]}-${dateMatch[2]}-${dateMatch[3]}`) : null;
const formattedDate = dateObj?.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
}) || '';
---

<BaseLayout title={post.data.title} description={post.data.description}>
  <div class="min-h-screen px-4 py-8 max-w-4xl mx-auto">
    <nav class="mb-6 text-sm">
      <a href="/posts/" class="text-brown-700 hover:text-teal-900">← Posts</a>
      {formattedDate && <span class="mx-2 text-brown-700">•</span>}
      {formattedDate && <time datetime={dateStr} class="text-brown-700">{formattedDate}</time>}
    </nav>

    <article>
      <header class="mb-8">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">{post.data.title}</h1>

        {post.data.tags && (
          <div class="flex flex-wrap gap-2 mb-4">
            {post.data.tags.split(',').map((tag: string) => {
              const trimmedTag = tag.trim();
              const tagSlug = trimmedTag.toLowerCase().replace(/\s+/g, '-');
              return (
                <a
                  href={`/tag/${tagSlug}/`}
                  class="text-xs bg-brown-200 text-brown-900 px-3 py-1 rounded-full hover:bg-brown-300 transition"
                >
                  {trimmedTag}
                </a>
              );
            })}
          </div>
        )}
      </header>

      <div class="prose prose-brown prose-lg max-w-none">
        <Content />
      </div>
    </article>

    <footer class="mt-12 p-6 border-4 border-dashed border-amber-500">
      <h2 class="text-2xl font-bold mb-4">Interested in more daily treasures like this one?</h2>
      <p class="mb-4">Sent directly to your inbox?</p>
      <div class="text-center">
        <a href="/subs/" class="inline-block bg-amber-500 text-brown-900 px-6 py-3 rounded font-bold hover:bg-amber-600 transition">
          Sign up for the newsletter
        </a>
      </div>
    </footer>
  </div>
</BaseLayout>
