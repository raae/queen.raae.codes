---
import BaseLayout from '../layouts/BaseLayout.astro';
import PageSection from '../components/PageSection.astro';
import PageSectionHeader from '../components/PageSectionHeader.astro';
import Newsletter from '../components/Newsletter.astro';
import { getCollection } from 'astro:content';

// Helper to format date like "January 25th, 2025"
function formatDate(dateStr: string): string {
  const date = new Date(dateStr);
  const options: Intl.DateTimeFormatOptions = { year: 'numeric', month: 'long', day: 'numeric' };
  const formatted = date.toLocaleDateString('en-US', options);
  // Add ordinal suffix (1st, 2nd, 3rd, etc.)
  const day = date.getDate();
  const suffix = day === 1 || day === 21 || day === 31 ? 'st'
               : day === 2 || day === 22 ? 'nd'
               : day === 3 || day === 23 ? 'rd'
               : 'th';
  return formatted.replace(/(\d+),/, `$1${suffix},`);
}

const queenPosts = await getCollection('posts-queen');
const sortedPosts = queenPosts.sort((a, b) => {
  const dateA = a.id.match(/(\d{4})\/(\d{2})\/(\d{2})/);
  const dateB = b.id.match(/(\d{4})\/(\d{2})\/(\d{2})/);
  if (dateA && dateB) {
    return new Date(`${dateB[1]}-${dateB[2]}-${dateB[3]}`).getTime() - new Date(`${dateA[1]}-${dateA[2]}-${dateA[3]}`).getTime();
  }
  return 0;
}).map((post) => {
  const dateMatch = post.id.match(/(\d{4})\/(\d{2})\/(\d{2})/);
  const dateStr = dateMatch ? `${dateMatch[1]}-${dateMatch[2]}-${dateMatch[3]}` : '';

  return {
    ...post,
    dateStr,
    formattedDate: formatDate(dateStr),
  };
});

const BADGE = "Posts";
const TITLE = "All the posts";
const DESCRIPTION = "Posts from sailing the high seas of the World Wide Web.";
---

<BaseLayout title={TITLE} description={DESCRIPTION}>
  <main>
    <PageSection component="header">
      <PageSectionHeader
        badge={BADGE}
        title={TITLE}
        lead={DESCRIPTION}
        hLevel={1}
      />
    </PageSection>

    <PageSection component="section">
      <ul class="list-none px-0 my-0 -ml-1 space-y-4">
        {sortedPosts.map((post) => (
          <li class="mx-2 px-5 py-3 pb-4 relative border-0 border-l-4 border-solid border-amber-500 flex flex-col transition hover:bg-amber-400/30 focus-within:border-l-transparent focus-within:ring-4 focus-within:ring-offset-4 focus-within:ring-amber-500">
            <h3 class="text-base my-0 font-bold">
              <a
                href={`/${post.slug}/`}
                class="text-inherit no-underline focus:outline-none"
              >
                <span class="absolute inset-0" aria-hidden="true"></span>
                {post.data.title}
              </a>
            </h3>
            <p class="text-xs my-0 order-first leading-8 font-medium text-teal-800 uppercase tracking-tight">
              {post.formattedDate}
            </p>
          </li>
        ))}
      </ul>
    </PageSection>

    <PageSection component="footer">
      <Newsletter />
    </PageSection>
  </main>
</BaseLayout>
